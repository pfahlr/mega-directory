generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}



datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingStatus {
  PENDING
  APPROVED
  REJECTED
  INACTIVE
}

enum DirectoryStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  PUBLIC
  ADMIN
  EDITOR
  MODERATOR
  CRAWLER
}

enum UserStatus {
  INVITED
  ACTIVE
  SUSPENDED
}

enum FeaturedSlotTier {
  HERO
  PREMIUM
  STANDARD
}

enum LlmTargetType {
  LISTING
  CATEGORY
  DIRECTORY
  SUBCATEGORY
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum ReportReason {
  SPAM
  INCORRECT_INFO
  INAPPROPRIATE
  DUPLICATE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum ImageFormat {
  WEBP
  AVIF
  JPG
  PNG
}


model Country {
  id             Int              @id
  name           String
  iso2           String           @unique
  iso3           String?
  numericCode    String?
  phoneCode      String?
  capital        String?
  currency       String?
  currencyName   String?
  currencySymbol String?
  tld            String?
  nativeName     String?
  region         String?
  subregion      String?
  translations   Json?
  timezones      Json?
  latitude       Float?
  longitude      Float?
  emoji          String?
  emojiU         String?
  wikiDataId     String?
  hasStates      Boolean         @default(true)
  hasPostalCodes Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  states      StateProvince[]
  cities      City[]
  postalCodes PostalCode[]
  listings    Listing[]         @relation("ListingCountry")
  listingAddresses ListingAddress[] @relation("AddressCountry")
  locations   Location[]        @relation("CountryLocations")
}

model StateProvince {
  id          Int       @id
  name        String
  stateCode   String?
  type        String?
  latitude    Float?
  longitude   Float?
  countryId   Int
  countryCode String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  country    Country    @relation(fields: [countryId], references: [id])
  cities     City[]
  postalCodes PostalCode[]
  listings   Listing[]  @relation("ListingState")
  listingAddresses ListingAddress[] @relation("AddressState")
  locations  Location[] @relation("StateLocations")

  @@index([countryId])
  @@unique([countryId, stateCode])
}

model City {
  id          Int             @id
  name        String
  asciiName   String?
  latitude    Float?
  longitude   Float?
  population  Int?
  timezone    String?
  wikiDataId  String?
  stateId     Int?
  stateCode   String?
  stateName   String?
  countryId   Int
  countryCode String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  country    Country          @relation(fields: [countryId], references: [id])
  state      StateProvince?   @relation(fields: [stateId], references: [id])
  postalCodes PostalCode[]
  listings   Listing[]        @relation("ListingCity")
  listingAddresses ListingAddress[] @relation("AddressCity")
  locations  Location[]       @relation("CityLocations")

  @@index([countryId])
  @@index([stateId])
}

model PostalCode {
  id          Int             @id @default(autoincrement())
  code        String
  placeName   String
  countryId   Int
  countryCode String
  stateId     Int?
  stateCode   String?
  stateName   String?
  countyName  String?
  countyCode  String?
  cityId      Int?
  latitude    Float?
  longitude   Float?
  accuracy    Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  country    Country          @relation(fields: [countryId], references: [id])
  state      StateProvince?   @relation(fields: [stateId], references: [id])
  city       City?            @relation(fields: [cityId], references: [id])
  listings   Listing[]        @relation("ListingPostalCode")
  listingAddresses ListingAddress[] @relation("AddressPostalCode")
  locations  Location[]       @relation("PostalCodeLocations")

  @@index([countryId, code])
  @@index([cityId])
  @@unique([countryId, code, placeName])
}

model Category {
  id              Int            @id @default(autoincrement())
  name            String
  slug            String         @unique
  description     String?
  metaTitle       String?
  metaDescription String?
  heroImageUrl    String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  listingCategories ListingCategory[]
  directories   Directory[]
  subcategories Subcategory[]
}

model Location {
  id              Int        @id @default(autoincrement())
  name            String
  slug            String     @unique
  state           String?
  country         String?    @default("US")
  timezone        String?
  latitude        Float?
  longitude       Float?
  metaTitle       String?
  metaDescription String?
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  countryId       Int?
  stateId         Int?
  cityId          Int?
  postalCodeId    Int?

  countryRecord    Country?       @relation("CountryLocations", fields: [countryId], references: [id])
  stateRecord      StateProvince? @relation("StateLocations", fields: [stateId], references: [id])
  cityRecord       City?          @relation("CityLocations", fields: [cityId], references: [id])
  postalCodeRecord PostalCode?    @relation("PostalCodeLocations", fields: [postalCodeId], references: [id])

  listings    Listing[]
  directories Directory[]

  @@index([countryId])
  @@index([stateId])
  @@index([cityId])
  @@index([postalCodeId])
}

model Directory {
  id              Int             @id @default(autoincrement())
  title           String
  slug            String          @unique
  subdomain       String          @unique
  subdirectory    String          @unique
  hostname        String?
  heroTitle       String?
  heroSubtitle    String?
  introMarkdown   String?
  status          DirectoryStatus @default(DRAFT)
  featuredLimit   Int             @default(3)
  metaTitle        String?        @map("meta_title")
  metaDescription  String?        @map("meta_description")
  metaKeywords     String?        @map("meta_keywords")
  ogImageUrl       String?        @map("og_image_url")
  locationAgnostic Boolean        @map("location_agnostic") @default(false)
  isActive        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  categoryId      Int
  locationId      Int?

  category   Category @relation(fields: [categoryId], references: [id])
  location   Location? @relation(fields: [locationId], references: [id])
  listings   Listing[]
  featuredSlots FeaturedSlot[]

  @@unique([categoryId, locationId])
  @@map("directory_pages")
}

model Subcategory {
  id            Int           @id @default(autoincrement())
  name          String
  slug          String
  description   String?
  displayOrder  Int           @default(0)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  categoryId    Int
  parentId      Int?

  category   Category    @relation(fields: [categoryId], references: [id])
  parent     Subcategory? @relation("SubcategoryChildren", fields: [parentId], references: [id])
  children   Subcategory[] @relation("SubcategoryChildren")
  listings   ListingSubcategory[]

  @@unique([categoryId, slug])
}

model Listing {
  id               Int              @id @default(autoincrement())
  title            String
  slug             String           @unique
  tagline          String?
  summary          String?
  description      String?
  websiteUrl       String?
  contactEmail     String?
  contactPhone     String?
  priceRange       String?
  rating           Float?           @default(0)
  reviewCount      Int?             @default(0)
  score            Float?           @default(0)
  status           ListingStatus    @default(PENDING)
  isClaimed        Boolean          @default(false)
  isSponsored      Boolean          @default(false)
  sourceName       String?
  sourceUrl        String?
  sourceId         String?          @unique
  crawlerRunId     String?
  rawPayload       Json?
  generatedPayload Json?
  notes            String?
  ingestedAt       DateTime?        @default(now())
  approvedAt       DateTime?
  publishedAt      DateTime?
  archivedAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  locationId       Int?
  directoryId      Int?
  approvedById     Int?
  countryId        Int?
  stateId          Int?
  cityId           Int?
  postalCodeId     Int?

  location      Location?            @relation(fields: [locationId], references: [id])
  directory     Directory?           @relation(fields: [directoryId], references: [id])
  approvedBy    User?                @relation("ListingApprovedBy", fields: [approvedById], references: [id])
  subcategories ListingSubcategory[]
  featuredSlots FeaturedSlot[]
  categories    ListingCategory[]
  addresses     ListingAddress[]
  countryRecord   Country?           @relation("ListingCountry", fields: [countryId], references: [id])
  stateRecord     StateProvince?     @relation("ListingState", fields: [stateId], references: [id])
  cityRecord      City?              @relation("ListingCity", fields: [cityId], references: [id])
  postalCodeRecord PostalCode?       @relation("ListingPostalCode", fields: [postalCodeId], references: [id])
  listItems       ListItem[]
  votes           Vote[]
  reports         Report[]
  reviews         Review[]

  @@index([directoryId])
  @@index([status])
  @@index([postalCodeId])
  @@index([cityId])
  @@index([stateId])
  @@index([countryId])
}

model ListingCategory {
  listing     Listing  @relation(fields: [listingId], references: [id])
  listingId   Int
  category    Category @relation(fields: [categoryId], references: [id])
  categoryId  Int
  isPrimary   Boolean  @default(false)
  assignedAt  DateTime @default(now())

  @@id([listingId, categoryId])
  @@index([categoryId])
}

model ListingAddress {
  id            Int       @id @default(autoincrement())
  listingId     Int
  label         String?
  addressLine1  String?
  addressLine2  String?
  city          String?
  region        String?
  postalCode    String?
  country       String?   @default("US")
  latitude      Float?
  longitude     Float?
  isPrimary     Boolean   @default(false)
  countryId     Int?
  stateId       Int?
  cityId        Int?
  postalCodeId  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  listing         Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)
  countryRecord   Country?       @relation("AddressCountry", fields: [countryId], references: [id])
  stateRecord     StateProvince? @relation("AddressState", fields: [stateId], references: [id])
  cityRecord      City?          @relation("AddressCity", fields: [cityId], references: [id])
  postalCodeRecord PostalCode?   @relation("AddressPostalCode", fields: [postalCodeId], references: [id])

  @@index([listingId])
  @@index([cityId])
  @@index([postalCodeId])
}

model ListingSubcategory {
  listing       Listing     @relation(fields: [listingId], references: [id])
  listingId     Int
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id])
  subcategoryId Int
  assignedAt    DateTime    @default(now())

  @@id([listingId, subcategoryId])
}

model FeaturedSlot {
  id          Int              @id @default(autoincrement())
  tier        FeaturedSlotTier
  position    Int              @default(1)
  label       String?
  startsAt    DateTime         @default(now())
  endsAt      DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  directoryId Int
  listingId   Int?

  directory Directory @relation(fields: [directoryId], references: [id])
  listing   Listing?  @relation(fields: [listingId], references: [id])

  @@unique([directoryId, tier, position])
}

model User {
  id             Int        @id @default(autoincrement())
  username       String     @unique @db.VarChar(50)
  email          String?    @db.VarChar(255)
  emailVerified  Boolean    @default(false)
  passwordHash   String?    @db.VarChar(255)
  photo          String?    @db.VarChar(500)
  about          String?    @db.VarChar(1024)
  displayName    String?
  role           UserRole   @default(PUBLIC)
  status         UserStatus @default(ACTIVE)
  apiTokenHash   String?
  lastLoginAt    DateTime?
  lastPasswordAt DateTime?
  metadata       Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  approvedListings Listing[] @relation("ListingApprovedBy")
  sessions         Session[]
  magicLinks       MagicLink[]
  userLists        UserList[]
  votes            Vote[]
  reports          Report[] @relation("ReportSubmitter")
  resolvedReports  Report[] @relation("ReportResolver")
  reviews          Review[]
  moderatedReviews Review[] @relation("ReviewModerator")

  @@unique([email], name: "email_unique", map: "users_email_key")
  @@index([email])
  @@index([username])
  @@index([createdAt])
}

model Session {
  id         Int      @id @default(autoincrement())
  userId     Int
  tokenHash  String   @db.VarChar(255)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.VarChar(500)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model MagicLink {
  id         Int       @id @default(autoincrement())
  userId     Int
  code       String    @unique @db.VarChar(12)
  email      String    @db.VarChar(255)
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())
  ipAddress  String?   @db.VarChar(45)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@index([email])
}

model UserList {
  id                Int        @id @default(autoincrement())
  userId            Int
  title             String     @db.VarChar(200)
  description       String?    @db.VarChar(2000)
  urlSlug           String     @db.VarChar(100)
  unlisted          Boolean    @default(false)
  locationAgnostic  Boolean    @default(false)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items ListItem[]

  @@unique([userId, urlSlug])
  @@index([userId])
  @@index([unlisted])
  @@index([createdAt])
}

model ListItem {
  id         Int      @id @default(autoincrement())
  listId     Int
  listingId  Int
  position   Int      @default(0)
  notes      String?  @db.VarChar(500)
  addedAt    DateTime @default(now())

  list    UserList @relation(fields: [listId], references: [id], onDelete: Cascade)
  listing Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listId, listingId])
  @@index([listId])
  @@index([listingId])
  @@index([position])
}

model Vote {
  id         Int      @id @default(autoincrement())
  userId     Int
  listingId  Int
  voteType   VoteType
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([listingId])
  @@index([userId])
  @@index([voteType])
}

model Report {
  id          Int          @id @default(autoincrement())
  userId      Int?
  listingId   Int
  reason      ReportReason
  details     String?      @db.VarChar(1000)
  status      ReportStatus @default(PENDING)
  adminNotes  String?      @db.VarChar(2000)
  resolvedBy  Int?
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  ipAddress   String?      @db.VarChar(45)

  user       User?    @relation("ReportSubmitter", fields: [userId], references: [id], onDelete: SetNull)
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  resolver   User?    @relation("ReportResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([listingId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([resolvedBy])
}

model Review {
  id            Int          @id @default(autoincrement())
  userId        Int
  listingId     Int
  rating        Int?
  text          String       @db.VarChar(5000)
  status        ReviewStatus @default(PENDING)
  spamScore     Decimal?     @db.Decimal(3, 2)
  spamDetails   Json?
  moderatedBy   Int?
  moderatedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  ipAddress     String?      @db.VarChar(45)

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)
  moderator User?          @relation("ReviewModerator", fields: [moderatedBy], references: [id], onDelete: SetNull)
  images    ReviewImage[]

  @@unique([userId, listingId])
  @@index([listingId])
  @@index([userId])
  @@index([status])
  @@index([spamScore])
  @@index([createdAt])
}

model ReviewImage {
  id               Int         @id @default(autoincrement())
  reviewId         Int
  originalFilename String      @db.VarChar(255)
  storedFilename   String      @db.VarChar(255)
  url              String      @db.VarChar(500)
  sizeBytes        Int
  width            Int?
  height           Int?
  format           ImageFormat
  uploadedAt       DateTime    @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([uploadedAt])
}

model LlmFieldConfig {
  id                Int            @id @default(autoincrement())
  targetType        LlmTargetType
  fieldName         String
  provider          String         @default("openrouter")
  model             String?
  promptTemplate    String
  stopSequences     String[]       @default([])
  maxTokens         Int?           @default(400)
  temperature       Float?         @default(0.7)
  topP              Float?         @default(1)
  isEnabled         Boolean        @default(true)
  version           Int            @default(1)
  outputSchema      Json?
  postProcessScript String?
  metadata          Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([targetType, fieldName, version])
}
