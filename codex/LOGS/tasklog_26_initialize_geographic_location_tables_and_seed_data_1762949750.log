OpenAI Codex v0.57.0 (research preview)
--------
workdir: /var/home/rick/Development/mega-directory
model: gpt-5-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019a77fe-6124-7be3-8b27-b0b258aa0e6b
--------
user
Implement the functionality described in codex/TASKS/26_initialize_geographic_location_tables_and_seed_data.yaml, then verify with any available tests.
ERROR: MCP client for `vibe-check-mcp-server` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:
[mcp_servers.vibe-check-mcp-server]
startup_timeout_sec = XX
ERROR: MCP client for `exa` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:
[mcp_servers.exa]
startup_timeout_sec = XX
ERROR: MCP client for `mcp` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:
[mcp_servers.mcp]
startup_timeout_sec = XX

thinking
**Preparing to inspect task instructions**
exec
bash -lc ls in /var/home/rick/Development/mega-directory succeeded in 93ms:
AGENTS.md
apps
codex
codex.toml
codex.yaml
db
docker-compose.yml
docs
docs.tar
env.json
Makefile
package.json
packages
README.md
scripts
tests
tsconfig.json

thinking
**Opening TASKS file**
exec
bash -lc "sed -n '1,160p' codex/TASKS/26_initialize_geographic_location_tables_and_seed_data.yaml" in /var/home/rick/Development/mega-directory succeeded in 43ms:
id: 26
filename: 26_initialize_geographic_location_tables_and_seed_data.yaml
title: Initialize Geographic Location Tables and Seed Data
description: >
Define and create database schema for global location hierarchy (countries, states, cities, postal codes).
Load seed data from public datasets
- dr5hn countries-states-cities-database "https://github.com/dr5hn/countries-states-cities-database"
- GeoNames postal code data "https://download.geonames.org/export/zip/"
Handle edge cases such as postal-code-less countries and provide fallback mechanisms.
- additional information regarding entire development project this task is part of can be referenced in `codex/TASKS/codex_phase_1b_2.yaml`
dependencies: []

thinking
**Seeking additional context files**
exec
bash -lc "sed -n '1,200p' codex/TASKS/codex_phase_1b_2.yaml" in /var/home/rick/Development/mega-directory succeeded in 42ms:
project: mega-directory
version: 1.0
phases:
  - phase: 1
    description: Core system buildout â€” listings pipeline, directory structure, admin tools, crawler, API, and frontend delivery

    components:
      api_server:
        language: TypeScript
        framework: Node/Express
        deployment: Railway
        endpoints:
          - listings: [GET, POST, PUT, DELETE]
          - addresses: [GET, POST, PUT, DELETE]
          - categories: [GET, POST, PUT, DELETE]
          - directory_pages: [GET, POST, PUT, DELETE]
          - directory_metadata: [GET, PUT]
        notes:
          - Postal, city, state/province, and country tables are loaded from external datasets.
          - Listings reference postal_code_id or city_id depending on geography.

thinking
**Assessing testing approach and repo structure**
exec
bash -lc 'ls db' in /var/home/rick/Development/mega-directory succeeded in 44ms:
migrations
schema.prisma
seed.ts

thinking
**Inspecting database schema**
exec
bash -lc "sed -n '1,200p' db/schema.prisma" in /var/home/rick/Development/mega-directory succeeded in 38ms:
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingStatus {
  PENDING
  APPROVED
  REJECTED
  INACTIVE
}

enum DirectoryStatus {
  DRAFT
  ACTIVE
  ARCHIVED

thinking
**Checking for more file content**
exec
bash -lc "sed -n '200,400p' db/schema.prisma" in /var/home/rick/Development/mega-directory succeeded in 45ms:
}

model FeaturedSlot {
  id          Int              @id @default(autoincrement())
  tier        FeaturedSlotTier
  position    Int              @default(1)
  label       String?
  startsAt    DateTime         @default(now())
  endsAt      DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  directoryId Int
  listingId   Int?

  directory Directory @relation(fields: [directoryId], references: [id])
  listing   Listing?  @relation(fields: [listingId], references: [id])

  @@unique([directoryId, tier, position])
}


thinking
**Planning geographic tables implementation**
exec
bash -lc "sed -n '1,200p' db/seed.ts" in /var/home/rick/Development/mega-directory succeeded in 44ms:
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  const adminUser = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      email: 'admin@example.com',
      passwordHash: 'placeholder-hash',
      displayName: 'Demo Admin',
      role: 'ADMIN',
      status: 'ACTIVE'
    }
  });

  const servicesCategory = await prisma.category.upsert({
    where: { slug: 'professional-services' },
    update: {},
exec
bash -lc "sed -n '200,400p' db/seed.ts" in /var/home/rick/Development/mega-directory succeeded in 40ms:
      isSponsored: true,
      score: 87.4,
      rating: 4.9,
      reviewCount: 128,
      sourceName: 'demo-seed',
      sourceId: 'seed-bright-sparks',
      ingestedAt: new Date(),
      approvedAt: new Date(),
      publishedAt: new Date(),
      approvedById: adminUser.id,
      categoryId: servicesCategory.id,
      locationId: nyc.id,
      directoryId: nycDirectory.id
    }
  });

  await prisma.listingSubcategory.upsert({
    where: {
      listingId_subcategoryId: {
        listingId: listing.id,
exec
bash -lc "sed -n '400,800p' db/seed.ts" in /var/home/rick/Development/mega-directory succeeded in 41ms:
      targetType: 'LISTING',
      fieldName: 'ai_summary',
      promptTemplate:
        'Summarize the business in 40 words, highlighting location coverage and specialties using second-person voice.',
      provider: 'openrouter',
      model: 'gpt-4o-mini',
      maxTokens: 160,
      temperature: 0.6,
      outputSchema: {
        type: 'object',
        properties: {
          summary: { type: 'string' },
          tone: { type: 'string', enum: ['trusted', 'energetic', 'premium'] }
        },
        required: ['summary', 'tone']
      }
    }
  });
}


thinking
**Planning database schema and seed data loading**
exec
bash -lc 'cat package.json' in /var/home/rick/Development/mega-directory succeeded in 96ms:
{
  "name": "mega-directory",
  "private": true,
  "version": "0.1.0",
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "test": "npm run test --workspaces --if-present"
  }
}

thinking
**Exploring apps directory**
exec
bash -lc 'ls apps' in /var/home/rick/Development/mega-directory succeeded in 40ms:
admin
api
crawler
web

thinking
**Planning location data integration**

Iâ€™m mapping out how to add location tables and related seeding functionality, starting with analyzing the repoâ€™s frameworks and schema. I want to understand how `apps/api` might use Express, then check for existing location models or services, and look into Prisma migrations to plan database updates and data import scripts. I'll explore references to `Country` and `Location` to connect the dots before implementing and testing the changes.
exec
bash -lc "rg -n \"Location\" -g'*.*'" in /var/home/rick/Development/mega-directory succeeded in 929ms:
apps/admin/test/categoryLocationService.test.js:4:const approvedStore = require('../data/categoryLocations');
apps/admin/test/categoryLocationService.test.js:5:const pendingStore = require('../data/categoryLocationDiscoveries');
apps/admin/test/categoryLocationService.test.js:7:  getPendingCategoryLocations,
apps/admin/test/categoryLocationService.test.js:8:  getApprovedCategoryLocations,
apps/admin/test/categoryLocationService.test.js:9:  approveCategoryLocations
apps/admin/test/categoryLocationService.test.js:10:} = require('../services/categoryLocationService');
apps/admin/test/categoryLocationService.test.js:20:test('getPendingCategoryLocations mirrors the pending store', () => {
apps/admin/test/categoryLocationService.test.js:23:  const pending = getPendingCategoryLocations();
apps/admin/test/categoryLocationService.test.js:28:test('getApprovedCategoryLocations mirrors the approved store', () => {
apps/admin/test/categoryLocationService.test.js:31:  const approved = getApprovedCategoryLocations();
apps/admin/test/categoryLocationService.test.js:36:test('approveCategoryLocations moves pending entry into approved store', () => {
apps/admin/test/categoryLocationService.test.js:40:  const result = approveCategoryLocations([{ id: target.id, approve: true }]);
apps/admin/test/categoryLocationService.test.js:47:test('approveCategoryLocations skips duplicates by slug and leaves pending intact', () => {
apps/admin/test/categoryLocationService.test.js:62:  const result = approveCategoryLocations([{ id: 'disc_duplicate_slug', approve: true }]);
apps/admin/index.js:6:const categoryLocationsRouter = require('./routes/categoryLocations');
apps/admin/index.js:25:app.use('/category-locations', categoryLocationsRouter);
apps/admin/views/category-locations/index.ejs:1:<%- include('../partials/page-start', { title: 'Category & Location Approvals', active: 'category-locations' }) %>
apps/admin/services/categoryLocationService.js:1:const approvedLocations = require('../data/categoryLocations');
apps/admin/services/categoryLocationService.js:2:const pendingLocations = require('../data/categoryLocationDiscoveries');
apps/admin/services/categoryLocationService.js:4:function getPendingCategoryLocations() {

thinking
**Opening relevant documentation**
exec
bash -lc "sed -n '1,200p' docs/development_phase_1b.md" in /var/home/rick/Development/mega-directory succeeded in 43ms:
# Development Phase 1 part B

The initial 20 codex tasks have been completed, and this has provided a solid base for the project. However, the project still falls short of a fully functioning application with all of the necessary moving parts. I'm sure this is because I failed to flesh out all of the details regarding the various workflows as I was particulary focused on the architecture. No problem, because this architecture is exactly what will make all of the remaining added functionality possible. 

We need to plan out some further development additions and refinements. It appears the api is missing a number of operations, but it seems the important base functionality is there so it shouldn't be a huge problem. I wanted to rethink some of the ways things work. Let's first of all think about the structure of the data. 

## Directory Pages

Rather than automatically generating directories from categories and locations, which could get messy if we try to have the system create all the permutations, furthermore, there will be significant SEO infomation that must be provided when creating a single directory page. So, we'll need a table to represent the individual directory pages. This way we can create directories that perhaps present more than one category or more than one postal code or city when these groupings represent very small amounts of listings or for whatever reason it makes sense to group or not group these together. The directory page can have its own title to concatenate with the site name to generate the content for the <title> tag and meta title, it can have an editable field for meta keywords, a field where the admin can specify the specific subdomain and the subdirectory used to represent the directory (based on the site configuration either the subdomain will 301 redirect to the subdirectory or the subdirectory to the subdomain, either way it should be possible for the admin to supply independent values for each of these), further meta tag values should include the description, og:image, etc. While the main site configuration should provide default values for these, it is important that it be possible to override them on individual directories.

It should also be a configuration option of the directory page whether the directory page should be location agnostic or not. If the directory page is NOT location agnostic, it should be relatively easy to provide a map widget displaying pins for each of the listings on the page. The user interface for this type of page could also include a pin icon at the end of the listing title that when clicked will cause the map widget to center on that listing. 

## Listing Locations and other Geographic Data

### Listing and physical_address tables

While we will be collecting a bunch of listings which are associated with various categories and locations. For some listings it may actually make sense to associate them with more than one category. It may even make sense to associate some listings with multiple addresses, but addresses should be associated only with a single listing (1234 some st. suite 1 and 1234 some st. suite 2 are separate addresses) So the *physical_address* table should have a foreign key on the *listing* table while listings and categories should be related via a join table.


### Country -> State/Province -> City -> Postal Data Structure

thinking
**Requesting additional document lines**
exec
bash -lc "sed -n '200,400p' docs/development_phase_1b.md" in /var/home/rick/Development/mega-directory succeeded in 42ms:


thinking
**Verifying file completeness**
exec
bash -lc 'cat docs/development_phase_1b.md' in /var/home/rick/Development/mega-directory succeeded in 40ms:
# Development Phase 1 part B

The initial 20 codex tasks have been completed, and this has provided a solid base for the project. However, the project still falls short of a fully functioning application with all of the necessary moving parts. I'm sure this is because I failed to flesh out all of the details regarding the various workflows as I was particulary focused on the architecture. No problem, because this architecture is exactly what will make all of the remaining added functionality possible. 

We need to plan out some further development additions and refinements. It appears the api is missing a number of operations, but it seems the important base functionality is there so it shouldn't be a huge problem. I wanted to rethink some of the ways things work. Let's first of all think about the structure of the data. 

## Directory Pages

Rather than automatically generating directories from categories and locations, which could get messy if we try to have the system create all the permutations, furthermore, there will be significant SEO infomation that must be provided when creating a single directory page. So, we'll need a table to represent the individual directory pages. This way we can create directories that perhaps present more than one category or more than one postal code or city when these groupings represent very small amounts of listings or for whatever reason it makes sense to group or not group these together. The directory page can have its own title to concatenate with the site name to generate the content for the <title> tag and meta title, it can have an editable field for meta keywords, a field where the admin can specify the specific subdomain and the subdirectory used to represent the directory (based on the site configuration either the subdomain will 301 redirect to the subdirectory or the subdirectory to the subdomain, either way it should be possible for the admin to supply independent values for each of these), further meta tag values should include the description, og:image, etc. While the main site configuration should provide default values for these, it is important that it be possible to override them on individual directories.

It should also be a configuration option of the directory page whether the directory page should be location agnostic or not. If the directory page is NOT location agnostic, it should be relatively easy to provide a map widget displaying pins for each of the listings on the page. The user interface for this type of page could also include a pin icon at the end of the listing title that when clicked will cause the map widget to center on that listing. 

## Listing Locations and other Geographic Data

### Listing and physical_address tables

While we will be collecting a bunch of listings which are associated with various categories and locations. For some listings it may actually make sense to associate them with more than one category. It may even make sense to associate some listings with multiple addresses, but addresses should be associated only with a single listing (1234 some st. suite 1 and 1234 some st. suite 2 are separate addresses) So the *physical_address* table should have a foreign key on the *listing* table while listings and categories should be related via a join table.


### Country -> State/Province -> City -> Postal Data Structure

thinking
**Preparing to implement location schema**
exec
bash -lc "sed -n '1,200p' db/migrations/001_core_schema.sql" in /var/home/rick/Development/mega-directory succeeded in 48ms:
-- Core relational schema for Mega Directory
-- Includes directories, listings, categorization, featured slots, users, and LLM configs

CREATE TYPE "ListingStatus" AS ENUM ('PENDING', 'APPROVED', 'REJECTED', 'INACTIVE');
CREATE TYPE "DirectoryStatus" AS ENUM ('DRAFT', 'ACTIVE', 'ARCHIVED');
CREATE TYPE "UserRole" AS ENUM ('ADMIN', 'EDITOR', 'MODERATOR', 'CRAWLER');
CREATE TYPE "UserStatus" AS ENUM ('INVITED', 'ACTIVE', 'SUSPENDED');
CREATE TYPE "FeaturedSlotTier" AS ENUM ('HERO', 'PREMIUM', 'STANDARD');
CREATE TYPE "LlmTargetType" AS ENUM ('LISTING', 'CATEGORY', 'DIRECTORY', 'SUBCATEGORY');

CREATE TABLE "User" (
  "id" SERIAL PRIMARY KEY,
  "email" TEXT NOT NULL UNIQUE,
  "passwordHash" TEXT NOT NULL,
  "displayName" TEXT,
  "role" "UserRole" NOT NULL DEFAULT 'ADMIN',
  "status" "UserStatus" NOT NULL DEFAULT 'INVITED',
  "apiTokenHash" TEXT,
  "lastLoginAt" TIMESTAMPTZ,
  "lastPasswordAt" TIMESTAMPTZ,

thinking
**Inspecting migration and API code for location**
exec
bash -lc "sed -n '1,200p' apps/api/src/server.ts" in /var/home/rick/Development/mega-directory succeeded in 42ms:
import express, { type Express, type Request, type RequestHandler } from 'express';
import jwt, { type JwtPayload } from 'jsonwebtoken';
import { DEFAULT_PORTS, PROJECT_NAME } from '@mega-directory/config';
import { createLogger, createRequestLogger, type Logger } from './logger';

const DEFAULT_PORT = DEFAULT_PORTS.api;
const DEFAULT_LISTING_STATUS: ListingStatus = 'INACTIVE';
const MAX_SLUG_LENGTH = 80;
const DEFAULT_ADMIN_TOKEN_TTL_SECONDS = 60 * 15;

type ListingStatus = 'INACTIVE' | 'ACTIVE';

type NullableString = string | null;

type ListingLocation =
  | {
      addressLine1?: string;
      addressLine2?: string;
      city?: string;
      region?: string;

thinking
**Planning geographic location database setup**

I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
exec
bash -lc 'rg -n "dr5hn" -n' in /var/home/rick/Development/mega-directory succeeded in 54ms:
docs/development_phase_1b.md:22:First of all there are *Categories* and *Locations*, Locations should be represented by a postal code. Each postal code should have a foreign key reference to a city (we'll call it that even though the exact what may vary), each city should have a foreign key reference to a state/province for countries that have these, alternatively they should have a foreign key reference directly to their country. (it may make sense to give countries with no state/province divisions a single state/province entry that just duplicates the country otherwise the city table will need foreign keys for both state/province and country), each state/province should have a foreign key reference to the country it is a part of. Each listing should have a foreign key reference to its zip/postal code entry... so, in the end we have a set of tables with this relationship, which can be found online, prepopulated here: https://github.com/dr5hn/countries-states-cities-database/tree/master/psql
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:56:- dr5hn countries-states-cities-database "https://github.com/dr5hn/countries-states-cities-database"
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:378:bash -lc 'rg -n "dr5hn" -n' in /var/home/rick/Development/mega-directory
codex/TASKS/codex_phase_1b_2.yaml:36:              - https://github.com/dr5hn/countries-states-cities-database
codex/TASKS/26_initialize_geographic_location_tables_and_seed_data.yaml:7:- dr5hn countries-states-cities-database "https://github.com/dr5hn/countries-states-cities-database"

thinking
**Inspecting codex LOGS directory**
exec
bash -lc "sed -n '1,200p' codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log" in /var/home/rick/Development/mega-directory succeeded in 46ms:
OpenAI Codex v0.57.0 (research preview)
--------
workdir: /var/home/rick/Development/mega-directory
model: gpt-5-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019a77fe-6124-7be3-8b27-b0b258aa0e6b
--------
user
Implement the functionality described in codex/TASKS/26_initialize_geographic_location_tables_and_seed_data.yaml, then verify with any available tests.
ERROR: MCP client for `vibe-check-mcp-server` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:
[mcp_servers.vibe-check-mcp-server]
startup_timeout_sec = XX
ERROR: MCP client for `exa` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:
[mcp_servers.exa]
startup_timeout_sec = XX
ERROR: MCP client for `mcp` timed out after 10 seconds. Add or adjust `startup_timeout_sec` in your config.toml:

thinking
**Continuing log review**
exec
bash -lc "sed -n '200,400p' codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log" in /var/home/rick/Development/mega-directory succeeded in 45ms:
      temperature: 0.6,
      outputSchema: {
        type: 'object',
        properties: {
          summary: { type: 'string' },
          tone: { type: 'string', enum: ['trusted', 'energetic', 'premium'] }
        },
        required: ['summary', 'tone']
      }
    }
  });
}


thinking
**Planning database schema and seed data loading**
exec
bash -lc 'cat package.json' in /var/home/rick/Development/mega-directory succeeded in 96ms:
{
  "name": "mega-directory",

thinking
**Planning data implementation steps**
exec
bash -lc 'rg -n "GeoNames" -n' in /var/home/rick/Development/mega-directory succeeded in 46ms:
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:57:- GeoNames postal code data "https://download.geonames.org/export/zip/"
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:381:codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:439:bash -lc 'rg -n "GeoNames" -n' in /var/home/rick/Development/mega-directory
codex/TASKS/26_initialize_geographic_location_tables_and_seed_data.yaml:8:- GeoNames postal code data "https://download.geonames.org/export/zip/"

thinking
**Searching for dataset files**
exec
bash -lc "rg --files | rg -i 'country|geoname|state|postal'" in /var/home/rick/Development/mega-directory exited 1 in 45ms:


thinking
**Optimizing command pipeline for search**
exec
bash -lc "rg --files | grep -i 'country\\|postal\\|geoname\\|state\\|city'" in /var/home/rick/Development/mega-directory exited 1 in 47ms:


thinking
**Planning database schema and dataset loading**

I'm considering adding new Prisma models for Country, State, City, and PostalCode and need to figure out how to load the datasets, since the dr5hn data isn't directly available in the repo and we lack network access. I'll check if something like `docs.tar` contains the dataset files so I can extract and use them offline.
exec
bash -lc 'tar tf docs.tar | head' in /var/home/rick/Development/mega-directory succeeded in 196ms:
docs/
docs/AGENTS.md
docs/deployment/
docs/deployment/railway.md
docs/monitoring.md
docs/development_phase_1b.md
docs/development_phase_1b_final.pdf
docs/development_phase_1b_tasks.pdf
docs/codex_tasks_detailed_final.zip
docs/codex_tasks_bundle.zip

thinking
**Investigating dataset availability**
exec
bash -lc 'ls scripts' in /var/home/rick/Development/mega-directory succeeded in 42ms:
dev-bootstrap.sh
dev_bootstrap.sh

thinking
**Designing hierarchical location schema**

I'm planning to create new Prisma models for Country, StateProvince, City, and PostalCode to build a global location hierarchy. Iâ€™m considering how to align or possibly replace the existing Location model, especially since Listings will need foreign keys to postal codes and cities, while handling edge cases like countries without postal codes. Iâ€™m also preparing to inspect code references to Location to ensure compatibility.
exec
bash -lc "rg -n \"locationId\" -g'*.*'" in /var/home/rick/Development/mega-directory succeeded in 48ms:
db/migrations/001_core_schema.sql:76:  "locationId" INTEGER,
db/migrations/001_core_schema.sql:77:  CONSTRAINT "directory_pages_categoryId_locationId_key" UNIQUE ("categoryId", "locationId"),
db/migrations/001_core_schema.sql:79:  CONSTRAINT "directory_pages_locationId_fkey" FOREIGN KEY ("locationId") REFERENCES "Location"("id") ON DELETE SET NULL ON UPDATE CASCADE
db/migrations/001_core_schema.sql:137:  "locationId" INTEGER,
db/migrations/001_core_schema.sql:141:  CONSTRAINT "Listing_locationId_fkey" FOREIGN KEY ("locationId") REFERENCES "Location"("id") ON DELETE SET NULL ON UPDATE CASCADE,
db/migrations/001_core_schema.sql:148:CREATE INDEX "Listing_category_location_idx" ON "Listing" ("categoryId", "locationId");
db/seed.ts:82:    locationId: nyc.id
db/seed.ts:107:    locationId: sf.id
db/seed.ts:132:    locationId: nyc.id
db/seed.ts:211:      locationId: nyc.id,
db/seed.ts:267:      locationId: nyc.id,
db/seed.ts:309:      locationId: nyc.id,
db/schema.prisma:106:  locationId      Int?
db/schema.prisma:109:  location   Location? @relation(fields: [locationId], references: [id])
db/schema.prisma:113:  @@unique([categoryId, locationId])
db/schema.prisma:176:  locationId       Int?
db/schema.prisma:181:  location      Location?            @relation(fields: [locationId], references: [id])
db/schema.prisma:189:  @@index([categoryId, locationId])
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:182:      locationId: nyc.id,
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:487:bash -lc "rg -n \"locationId\" -g'*.*'" in /var/home/rick/Development/mega-directory

thinking
**Exploring usage of postalCode**
exec
bash -lc 'rg -n "postalCode" -n' in /var/home/rick/Development/mega-directory succeeded in 51ms:
db/schema.prisma:151:  postalCode       String?
apps/api/src/server.ts:21:      postalCode?: string;
apps/api/src/server.ts:550:  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'] as const;
db/seed.ts:196:      postalCode: '10004',
db/migrations/001_core_schema.sql:112:  "postalCode" TEXT,
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:510:**Exploring usage of postalCode**
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:512:bash -lc 'rg -n "postalCode" -n' in /var/home/rick/Development/mega-directory
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:1205:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:1462:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:1859:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:2283:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:2687:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:3109:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:3531:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:3953:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:4374:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_04_implement_listing_ingestion_api_endpoint_1762853214.log:4788:+  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_09_add_category_meta_and_seo_controls_1762856433.log:123:  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_08_setup_featured_listings_logic_1762855542.log:222:  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];
codex/LOGS/tasklog_12_post_listings_from_crawler_to_api_server_1762857915.log:342:  const fields = ['addressLine1', 'addressLine2', 'city', 'region', 'postalCode', 'country'];

thinking
**Planning database schema and seeding**
exec
bash -lc "sed -n '1,200p' README.md" in /var/home/rick/Development/mega-directory succeeded in 40ms:
# Mega Directory

Mega Directory is a server-rendered directory listing platform built with Astro, Express, and Prisma. It supports dynamic subdomains, AI-generated content enrichment, and moderation workflows.

## Features

- ðŸ›°ï¸ Subdomain-based regional directories (e.g. electricians.nyc.example.com)
- âš¡ Express API with JWT-based auth
- ðŸ§  AI agents for crawling, enrichment, and moderation (via OpenRouter)
- ðŸ§© Admin dashboard for approving or rejecting listings
- ðŸ’… Tailwind CSS and minimal JavaScript for accessibility and performance
- ðŸ³ Dockerized and deployable behind Cloudflare with SSR

## Tech Stack

- Astro (SSR)
- Express.js
- Prisma + PostgreSQL
- Tailwind CSS
- OpenRouter (AI Agents)

thinking
**Checking packages directory**
exec
bash -lc 'ls packages' in /var/home/rick/Development/mega-directory succeeded in 40ms:
shared-config

thinking
**Checking shared-config list**
exec
bash -lc 'ls packages/shared-config' in /var/home/rick/Development/mega-directory succeeded in 41ms:
index.d.ts
index.js
package.json
README.md

thinking
**Opening index.js file**
exec
bash -lc 'cat packages/shared-config/index.js' in /var/home/rick/Development/mega-directory succeeded in 43ms:
const PROJECT_NAME = 'Mega Directory';

const DEFAULT_PORTS = Object.freeze({
  api: 3001,
  web: 3000,
  admin: 4000
});

const HEALTH_ENDPOINT = '/health';

module.exports = {
  PROJECT_NAME,
  DEFAULT_PORTS,
  HEALTH_ENDPOINT
};

thinking
**Planning schema and data loading**
exec
bash -lc 'ls tests' in /var/home/rick/Development/mega-directory succeeded in 38ms:
dev_bootstrap_test.sh

thinking
**Opening file for inspection**
exec
bash -lc "sed -n '1,200p' tests/dev_bootstrap_test.sh" in /var/home/rick/Development/mega-directory succeeded in 41ms:
#!/usr/bin/env bash

set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SCRIPT_PATH="${PROJECT_ROOT}/scripts/dev_bootstrap.sh"

if [[ ! -x "${SCRIPT_PATH}" ]]; then
  echo "Expected ${SCRIPT_PATH} to exist and be executable." >&2
  exit 1
fi

TEST_ARGS=(--fake-flag foo)
if ! output=$(DEV_BOOTSTRAP_TEST_MODE=1 "${SCRIPT_PATH}" "${TEST_ARGS[@]}" 2>&1); then
  echo "scripts/dev_bootstrap.sh failed in test mode" >&2
  exit 1
fi

if [[ "${output}" != *"dev_bootstrap"* ]]; then
  echo "Expected test-mode output to mention dev_bootstrap: ${output}" >&2

thinking
**Exploring test setup and locations**
exec
bash -lc 'ls apps/admin/test' in /var/home/rick/Development/mega-directory succeeded in 41ms:
categoryLocationService.test.js
listingsService.test.js
seoService.test.js

thinking
**Checking test setup**
exec
bash -lc 'cat apps/admin/package.json' in /var/home/rick/Development/mega-directory succeeded in 41ms:
{
  "name": "mega-directory-admin",
  "private": true,
  "version": "0.1.0",
  "main": "index.js",
  "scripts": {
    "dev": "node index.js",
    "start": "node index.js",
    "test": "node --test"
  },
  "dependencies": {
    "ejs": "^3.1.10",
    "express": "^4.19.2"
  }
}

thinking
**Checking for TypeScript and tests in apps/api**
exec
bash -lc 'cat apps/api/package.json' in /var/home/rick/Development/mega-directory succeeded in 39ms:
{
  "name": "mega-directory-api",
  "private": true,
  "version": "0.1.0",
  "type": "commonjs",
  "main": "dist/server.js",
  "types": "dist/server.d.ts",
  "scripts": {
    "dev": "npm run build && node dist/server.js",
    "dev:watch": "tsc -p tsconfig.json --watch",
    "build": "tsc -p tsconfig.json",
    "start": "node dist/server.js",
    "test": "npm run build && node --test test/**/*.test.js"
  },
  "dependencies": {
    "@mega-directory/config": "file:../../packages/shared-config",
    "express": "^4.21.2",
    "jsonwebtoken": "^9.0.2"
  },
  "devDependencies": {

thinking
**Listing tests in apps/api**
exec
bash -lc 'ls apps/api/test' in /var/home/rick/Development/mega-directory succeeded in 49ms:
server.test.js

thinking
**Designing location schema and data loader**

Iâ€™m sorting out how to define detailed tables for countries, states, cities, and postal codes with Prisma and SQL migrations, plus planning a seeding script that can handle large public datasets like dr5hn and GeoNames. Because the dataset is huge and network access may be restricted, Iâ€™m thinking of including sample data for tests and making the loader graceful if data is missing. I also need to update the existing `Location` and `Listing` models to integrate with the new schema while preserving compatibility. Getting the environment and dependency setup right for the new seed scripts is another puzzle Iâ€™m considering carefully.
exec
bash -lc 'rg -n "prisma" package*.json' in /var/home/rick/Development/mega-directory exited 1 in 47ms:


thinking
**Searching for Prisma in package.json files**
exec
bash -lc "rg -n \"prisma\" -g'package*.json'" in /var/home/rick/Development/mega-directory exited 1 in 47ms:


thinking
**Planning Prisma schema updates**

I'll map out a plan to review schema requirements, update Prisma schema and migrations, enhance seed scripts, and ensure tests still pass, all while noting that Prisma isn't fully integrated yet in this repo.
Plan update
  â†’ Analyze task requirements and existing database setup for location data.
  â€¢ Implement schema + migration changes for country/state/city/postal hierarchy with fallbacks.
  â€¢ Add seeding utilities + fixtures referencing public datasets and wire samples into existing seeds.
  â€¢ Run available tests and summarize results.

thinking
**Designing location data schema and migration plan**

I'm working through detailed designs for new geographic tablesâ€”Country, StateProvince, City, PostalCodeâ€”and planning schema updates, migrations, and seeding strategies to integrate them cleanly with existing Location and Listing models, while figuring out proper naming, relations, and efficient dataset loading next.
exec
bash -lc "rg -n \"Prisma\" -g'*.*'" in /var/home/rick/Development/mega-directory succeeded in 51ms:
README.md:3:Mega Directory is a server-rendered directory listing platform built with Astro, Express, and Prisma. It supports dynamic subdomains, AI-generated content enrichment, and moderation workflows.
README.md:18:- Prisma + PostgreSQL
README.md:35:Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
README.md:109:/db           - Prisma schema and seeding scripts
db/seed.ts:1:import { PrismaClient } from '@prisma/client';
db/seed.ts:3:const prisma = new PrismaClient();
AGENTS.md:82:* PostgreSQL (via Prisma or native driver)
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:149:import { PrismaClient } from '@prisma/client';
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:151:const prisma = new PrismaClient();
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:243:Iâ€™m mapping out how to add location tables and related seeding functionality, starting with analyzing the repoâ€™s frameworks and schema. I want to understand how `apps/api` might use Express, then check for existing location models or services, and look into Prisma migrations to plan database updates and data import scripts. I'll explore references to `Country` and `Location` to connect the dots before implementing and testing the changes.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:381:codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:441:codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:442:codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:381:codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:376:I'm outlining the steps to add database tables and seed data for geographic locations like countries, states, cities, and postal codes. Iâ€™ll check Prisma schema updates, existing scripts, and dataset references such as dr5hn and GeoNames to align the new structure properly.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:461:I'm considering adding new Prisma models for Country, State, City, and PostalCode and need to figure out how to load the datasets, since the dr5hn data isn't directly available in the repo and we lack network access. I'll check if something like `docs.tar` contains the dataset files so I can extract and use them offline.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:485:I'm planning to create new Prisma models for Country, StateProvince, City, and PostalCode to build a global location hierarchy. Iâ€™m considering how to align or possibly replace the existing Location model, especially since Listings will need foreign keys to postal codes and cities, while handling edge cases like countries without postal codes. Iâ€™m also preparing to inspect code references to Location to ensure compatibility.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:540:Mega Directory is a server-rendered directory listing platform built with Astro, Express, and Prisma. It supports dynamic subdomains, AI-generated content enrichment, and moderation workflows.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:555:- Prisma + PostgreSQL
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:687:Iâ€™m sorting out how to define detailed tables for countries, states, cities, and postal codes with Prisma and SQL migrations, plus planning a seeding script that can handle large public datasets like dr5hn and GeoNames. Because the dataset is huge and network access may be restricted, Iâ€™m thinking of including sample data for tests and making the loader graceful if data is missing. I also need to update the existing `Location` and `Listing` models to integrate with the new schema while preserving compatibility. Getting the environment and dependency setup right for the new seed scripts is another puzzle Iâ€™m considering carefully.
codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log:693:**Searching for Prisma in package.json files**

thinking
**Planning dataset and seed script updates**

Iâ€™m working through how to add a minimal sample dataset for the seed script so it can run tests without needing the full dataset. Iâ€™m also figuring out where to store this sample data, how to align it with actual dataset structures for smooth parsing, and how to document environment variables for loading either the sample or real data. Finally, Iâ€™m considering dependencies like `@prisma/client` and revisions needed in the seed script, README, and Makefile for seamless integration.
exec
bash -lc 'cat Makefile' in /var/home/rick/Development/mega-directory succeeded in 45ms:
.PHONY: sops-encryptkeys sops-updatekeys sops-decrypt sops-env-export


sops-encryptkeys:
	@file="$(FILE)"; if [ -z "$$file" ]; then file=env.json; fi; \
        if ! command -v sops >/dev/null 2>&1; then echo "sops not found; install sops first"; exit 1; fi; \
        if [ ! -f "$$file" ]; then echo "File not found: $$file"; exit 1; fi; \
        sops -e "$$file" > "$$file.tmp" && mv "$$file.tmp" "$$file"

## Rewrap SOPS file with new recipients from .sops.yaml
## Usage: make sops-updatekeys [FILE=env.json]
sops-updatekeys:
	@file="$(FILE)"; if [ -z "$$file" ]; then file=env.json; fi; \
        if ! command -v sops >/dev/null 2>&1; then echo "sops not found; install sops first"; exit 1; fi; \
        if [ ! -f "$$file" ]; then echo "File not found: $$file"; exit 1; fi; \
        sops updatekeys "$$file"

## Decrypt a SOPS file to stdout (or redirect to a file)
## Usage: make sops-decrypt [FILE=env.json]
sops-decrypt:

thinking
**Preparing documentation and dataset instructions**
exec
bash -lc 'cat tsconfig.json' in /var/home/rick/Development/mega-directory succeeded in 54ms:
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true
  }
}

thinking
**Marking step 1 complete**
Plan update
  âœ“ Analyze task requirements and existing database setup for location data.
  â†’ Implement schema + migration changes for country/state/city/postal hierarchy with fallbacks.
  â€¢ Add seeding utilities + fixtures referencing public datasets and wire samples into existing seeds.
  â€¢ Run available tests and summarize results.


thinking
**Planning schema.prisma geographic model updates**

I'm mapping out extensive changes to `schema.prisma` to add Country, StateProvince, City, and PostalCode models with detailed relations and indexes, then updating Location and Listing to link these new entities properly; I'll rewrite the entire schema file via patch to keep schema consistent and enable rich location data handling.
thinking
**Finalizing schema relation consistency and patch plan**
exec
bash -lc "cat <<'EOF' >/tmp/new_schema.prisma
generator client {
  provider = \"prisma-client-js\"
}



datasource db {
  provider = \"postgresql\"
  url      = env(\"DATABASE_URL\")
}

enum ListingStatus {
  PENDING
  APPROVED
  REJECTED
  INACTIVE
}

enum DirectoryStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  ADMIN
  EDITOR
  MODERATOR
  CRAWLER
}

enum UserStatus {
  INVITED
  ACTIVE
  SUSPENDED
}

enum FeaturedSlotTier {
  HERO
  PREMIUM
  STANDARD
}

enum LlmTargetType {
  LISTING
  CATEGORY
  DIRECTORY
  SUBCATEGORY
}

model Country {
  id             Int              @id
  name           String
  iso2           String           @unique
  iso3           String?
  numericCode    String?
  phoneCode      String?
  capital        String?
  currency       String?
  currencyName   String?
  currencySymbol String?
  tld            String?
  nativeName     String?
  region         String?
  subregion      String?
  translations   Json?
  timezones      Json?
  latitude       Float?
  longitude      Float?
  emoji          String?
  emojiU         String?
  wikiDataId     String?
  hasStates      Boolean         @default(true)
  hasPostalCodes Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  states      StateProvince[]
  cities      City[]
  postalCodes PostalCode[]
  listings    Listing[]         @relation(\"ListingCountry\")
  locations   Location[]        @relation(\"CountryLocations\")
}

model StateProvince {
  id          Int       @id
  name        String
  stateCode   String?
  type        String?
  latitude    Float?
  longitude   Float?
  countryId   Int
  countryCode String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  country    Country    @relation(fields: [countryId], references: [id])
  cities     City[]
  postalCodes PostalCode[]
  listings   Listing[]  @relation(\"ListingState\")
  locations  Location[] @relation(\"StateLocations\")

  @@index([countryId])
  @@unique([countryId, stateCode])
}

model City {
  id          Int             @id
  name        String
  asciiName   String?
  latitude    Float?
  longitude   Float?
  population  Int?
  timezone    String?
  wikiDataId  String?
  stateId     Int?
  stateCode   String?
  stateName   String?
  countryId   Int
  countryCode String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  country    Country          @relation(fields: [countryId], references: [id])
  state      StateProvince?   @relation(fields: [stateId], references: [id])
  postalCodes PostalCode[]
  listings   Listing[]        @relation(\"ListingCity\")
  locations  Location[]       @relation(\"CityLocations\")

  @@index([countryId])
  @@index([stateId])
}

model PostalCode {
  id          Int             @id @default(autoincrement())
  code        String
  placeName   String
  countryId   Int
  countryCode String
  stateId     Int?
  stateCode   String?
  stateName   String?
  countyName  String?
  countyCode  String?
  cityId      Int?
  latitude    Float?
  longitude   Float?
  accuracy    Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  country    Country          @relation(fields: [countryId], references: [id])
  state      StateProvince?   @relation(fields: [stateId], references: [id])
  city       City?            @relation(fields: [cityId], references: [id])
  listings   Listing[]        @relation(\"ListingPostalCode\")
  locations  Location[]       @relation(\"PostalCodeLocations\")

  @@index([countryId, code])
  @@index([cityId])
}

model Category {
  id              Int            @id @default(autoincrement())
  name            String
  slug            String         @unique
  description     String?
  metaTitle       String?
  metaDescription String?
  heroImageUrl    String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  listings      Listing[]
  directories   Directory[]
  subcategories Subcategory[]
}

model Location {
  id              Int        @id @default(autoincrement())
  name            String
  slug            String     @unique
  state           String?
  country         String?    @default(\"US\")
  timezone        String?
  latitude        Float?
  longitude       Float?
  metaTitle       String?
  metaDescription String?
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  countryId       Int?
  stateId         Int?
  cityId          Int?
  postalCodeId    Int?

  countryRecord    Country?       @relation(\"CountryLocations\", fields: [countryId], references: [id])
  stateRecord      StateProvince? @relation(\"StateLocations\", fields: [stateId], references: [id])
  cityRecord       City?          @relation(\"CityLocations\", fields: [cityId], references: [id])
  postalCodeRecord PostalCode?    @relation(\"PostalCodeLocations\", fields: [postalCodeId], references: [id])

  listings    Listing[]
  directories Directory[]

  @@index([countryId])
  @@index([stateId])
  @@index([cityId])
  @@index([postalCodeId])
}

model Directory {
  id              Int             @id @default(autoincrement())
  title           String
  slug            String          @unique
  subdomain       String          @unique
  subdirectory    String          @unique
  hostname        String?
  heroTitle       String?
  heroSubtitle    String?
  introMarkdown   String?
  status          DirectoryStatus @default(DRAFT)
  featuredLimit   Int             @default(3)
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImageUrl      String?
  locationAgnostic Boolean        @default(false)
  isActive        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  categoryId      Int
  locationId      Int?

  category   Category @relation(fields: [categoryId], references: [id])
  location   Location? @relation(fields: [locationId], references: [id])
  listings   Listing[]
  featuredSlots FeaturedSlot[]

  @@unique([categoryId, locationId])
  @@map(\"directory_pages\")
}

model Subcategory {
  id            Int           @id @default(autoincrement())
  name          String
  slug          String
  description   String?
  displayOrder  Int           @default(0)
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  categoryId    Int
  parentId      Int?

  category   Category    @relation(fields: [categoryId], references: [id])
  parent     Subcategory? @relation(\"SubcategoryChildren\", fields: [parentId], references: [id])
  children   Subcategory[] @relation(\"SubcategoryChildren\")
  listings   ListingSubcategory[]

  @@unique([categoryId, slug])
}

model Listing {
  id               Int              @id @default(autoincrement())
  title            String
  slug             String           @unique
  tagline          String?
  summary          String?
  description      String?
  websiteUrl       String?
  contactEmail     String?
  contactPhone     String?
  addressLine1     String?
  addressLine2     String?
  city             String?
  region           String?
  postalCode       String?
  country          String?          @default(\"US\")
  latitude         Float?
  longitude        Float?
  priceRange       String?
  rating           Float?           @default(0)
  reviewCount      Int?             @default(0)
  score            Float?           @default(0)
  status           ListingStatus    @default(PENDING)
  isClaimed        Boolean          @default(false)
  isSponsored      Boolean          @default(false)
  sourceName       String?
  sourceUrl        String?
  sourceId         String?          @unique
  crawlerRunId     String?
  rawPayload       Json?
  generatedPayload Json?
  notes            String?
  ingestedAt       DateTime?        @default(now())
  approvedAt       DateTime?
  publishedAt      DateTime?
  archivedAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  categoryId       Int
  locationId       Int?
  directoryId      Int?
  approvedById     Int?
  countryId        Int?
  stateId          Int?
  cityId           Int?
  postalCodeId     Int?

  category      Category             @relation(fields: [categoryId], references: [id])
  location      Location?            @relation(fields: [locationId], references: [id])
  directory     Directory?           @relation(fields: [directoryId], references: [id])
  approvedBy    User?                @relation(\"ListingApprovedBy\", fields: [approvedById], references: [id])
  subcategories ListingSubcategory[]
  featuredSlots FeaturedSlot[]
  countryRecord   Country?           @relation(\"ListingCountry\", fields: [countryId], references: [id])
  stateRecord     StateProvince?     @relation(\"ListingState\", fields: [stateId], references: [id])
  cityRecord      City?              @relation(\"ListingCity\", fields: [cityId], references: [id])
  postalCodeRecord PostalCode?       @relation(\"ListingPostalCode\", fields: [postalCodeId], references: [id])

  @@index([directoryId])
  @@index([status])
  @@index([categoryId, locationId])
  @@index([postalCodeId])
  @@index([cityId])
  @@index([stateId])
  @@index([countryId])
}

model ListingSubcategory {
  listing       Listing     @relation(fields: [listingId], references: [id])
  listingId     Int
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id])
  subcategoryId Int
  assignedAt    DateTime    @default(now())

  @@id([listingId, subcategoryId])
}

model FeaturedSlot {
  id          Int              @id @default(autoincrement())
  tier        FeaturedSlotTier
  position    Int              @default(1)
  label       String?
  startsAt    DateTime         @default(now())
  endsAt      DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  directoryId Int
  listingId   Int?

  directory Directory @relation(fields: [directoryId], references: [id])
  listing   Listing?  @relation(fields: [listingId], references: [id])

  @@unique([directoryId, tier, position])
}

model User {
  id             Int        @id @default(autoincrement())
  email          String     @unique
  passwordHash   String
  displayName    String?
  role           UserRole   @default(ADMIN)
  status         UserStatus @default(INVITED)
  apiTokenHash   String?
  lastLoginAt    DateTime?
  lastPasswordAt DateTime?
  metadata       Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  approvedListings Listing[] @relation(\"ListingApprovedBy\")
}

model LlmFieldConfig {
  id                Int            @id @default(autoincrement())
  targetType        LlmTargetType
  fieldName         String
  provider          String         @default(\"openrouter\")
  model             String?
  promptTemplate    String
  stopSequences     String[]       @default([])
  maxTokens         Int?           @default(400)
  temperature       Float?         @default(0.7)
  topP              Float?         @default(1)
  isEnabled         Boolean        @default(true)
  version           Int            @default(1)
  outputSchema      Json?
  postProcessScript String?
  metadata          Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([targetType, fieldName, version])
}
EOF" in /var/home/rick/Development/mega-directory succeeded in 49ms:


thinking
**Deciding how to update schema file**
exec
bash -lc 'cp /tmp/new_schema.prisma db/schema.prisma' in /var/home/rick/Development/mega-directory succeeded in 107ms:


thinking
**Drafting SQL migration for location hierarchy**

Iâ€™m planning to create a new migration file defining several tablesâ€”Country, StateProvince, City, PostalCodeâ€”with appropriate columns, indexes, and foreign key constraints. Iâ€™ll also alter Location and Listing tables to add hierarchical location columns and foreign keys, ensuring consistent naming and indexing while respecting existing styles and cascade rules. This will all go into `db/migrations/002_location_hierarchy.sql`.
exec
bash -lc "cat <<'EOF' > db/migrations/002_location_hierarchy.sql
-- Geographic hierarchy tables and related foreign keys
-- Includes countries, states/provinces, cities, and postal codes plus
-- bridge columns on locations/listings for direct references

CREATE TABLE \"Country\" (
  \"id\" INTEGER PRIMARY KEY,
  \"name\" TEXT NOT NULL,
  \"iso2\" TEXT NOT NULL UNIQUE,
  \"iso3\" TEXT,
  \"numericCode\" TEXT,
  \"phoneCode\" TEXT,
  \"capital\" TEXT,
  \"currency\" TEXT,
  \"currencyName\" TEXT,
  \"currencySymbol\" TEXT,
  \"tld\" TEXT,
  \"nativeName\" TEXT,
  \"region\" TEXT,
  \"subregion\" TEXT,
  \"translations\" JSONB,
  \"timezones\" JSONB,
  \"latitude\" DOUBLE PRECISION,
  \"longitude\" DOUBLE PRECISION,
  \"emoji\" TEXT,
  \"emojiU\" TEXT,
  \"wikiDataId\" TEXT,
  \"hasStates\" BOOLEAN NOT NULL DEFAULT TRUE,
  \"hasPostalCodes\" BOOLEAN NOT NULL DEFAULT TRUE,
  \"createdAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  \"updatedAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE \"StateProvince\" (
  \"id\" INTEGER PRIMARY KEY,
  \"name\" TEXT NOT NULL,
  \"stateCode\" TEXT,
  \"type\" TEXT,
  \"latitude\" DOUBLE PRECISION,
  \"longitude\" DOUBLE PRECISION,
  \"countryId\" INTEGER NOT NULL,
  \"countryCode\" TEXT NOT NULL,
  \"createdAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  \"updatedAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT \"StateProvince_countryId_fkey\" FOREIGN KEY (\"countryId\") REFERENCES \"Country\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX \"StateProvince_countryId_idx\" ON \"StateProvince\" (\"countryId\");
CREATE UNIQUE INDEX \"StateProvince_countryId_stateCode_key\" ON \"StateProvince\" (\"countryId\", \"stateCode\");

CREATE TABLE \"City\" (
  \"id\" INTEGER PRIMARY KEY,
  \"name\" TEXT NOT NULL,
  \"asciiName\" TEXT,
  \"latitude\" DOUBLE PRECISION,
  \"longitude\" DOUBLE PRECISION,
  \"population\" INTEGER,
  \"timezone\" TEXT,
  \"wikiDataId\" TEXT,
  \"stateId\" INTEGER,
  \"stateCode\" TEXT,
  \"stateName\" TEXT,
  \"countryId\" INTEGER NOT NULL,
  \"countryCode\" TEXT NOT NULL,
  \"createdAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  \"updatedAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT \"City_countryId_fkey\" FOREIGN KEY (\"countryId\") REFERENCES \"Country\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT \"City_stateId_fkey\" FOREIGN KEY (\"stateId\") REFERENCES \"StateProvince\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE INDEX \"City_countryId_idx\" ON \"City\" (\"countryId\");
CREATE INDEX \"City_stateId_idx\" ON \"City\" (\"stateId\");

CREATE TABLE \"PostalCode\" (
  \"id\" SERIAL PRIMARY KEY,
  \"code\" TEXT NOT NULL,
  \"placeName\" TEXT NOT NULL,
  \"countryId\" INTEGER NOT NULL,
  \"countryCode\" TEXT NOT NULL,
  \"stateId\" INTEGER,
  \"stateCode\" TEXT,
  \"stateName\" TEXT,
  \"countyName\" TEXT,
  \"countyCode\" TEXT,
  \"cityId\" INTEGER,
  \"latitude\" DOUBLE PRECISION,
  \"longitude\" DOUBLE PRECISION,
  \"accuracy\" INTEGER,
  \"createdAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  \"updatedAt\" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT \"PostalCode_countryId_fkey\" FOREIGN KEY (\"countryId\") REFERENCES \"Country\"(\"id\") ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT \"PostalCode_stateId_fkey\" FOREIGN KEY (\"stateId\") REFERENCES \"StateProvince\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT \"PostalCode_cityId_fkey\" FOREIGN KEY (\"cityId\") REFERENCES \"City\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE INDEX \"PostalCode_country_code_idx\" ON \"PostalCode\" (\"countryId\", \"code\");
CREATE INDEX \"PostalCode_cityId_idx\" ON \"PostalCode\" (\"cityId\");

ALTER TABLE \"Location\"
  ADD COLUMN \"countryId\" INTEGER,
  ADD COLUMN \"stateId\" INTEGER,
  ADD COLUMN \"cityId\" INTEGER,
  ADD COLUMN \"postalCodeId\" INTEGER;

ALTER TABLE \"Location\"
  ADD CONSTRAINT \"Location_countryId_fkey\" FOREIGN KEY (\"countryId\") REFERENCES \"Country\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Location\"
  ADD CONSTRAINT \"Location_stateId_fkey\" FOREIGN KEY (\"stateId\") REFERENCES \"StateProvince\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Location\"
  ADD CONSTRAINT \"Location_cityId_fkey\" FOREIGN KEY (\"cityId\") REFERENCES \"City\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Location\"
  ADD CONSTRAINT \"Location_postalCodeId_fkey\" FOREIGN KEY (\"postalCodeId\") REFERENCES \"PostalCode\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;

CREATE INDEX \"Location_countryId_idx\" ON \"Location\" (\"countryId\");
CREATE INDEX \"Location_stateId_idx\" ON \"Location\" (\"stateId\");
CREATE INDEX \"Location_cityId_idx\" ON \"Location\" (\"cityId\");
CREATE INDEX \"Location_postalCodeId_idx\" ON \"Location\" (\"postalCodeId\");

ALTER TABLE \"Listing\"
  ADD COLUMN \"countryId\" INTEGER,
  ADD COLUMN \"stateId\" INTEGER,
  ADD COLUMN \"cityId\" INTEGER,
  ADD COLUMN \"postalCodeId\" INTEGER;

ALTER TABLE \"Listing\"
  ADD CONSTRAINT \"Listing_countryId_fkey\" FOREIGN KEY (\"countryId\") REFERENCES \"Country\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Listing\"
  ADD CONSTRAINT \"Listing_stateId_fkey\" FOREIGN KEY (\"stateId\") REFERENCES \"StateProvince\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Listing\"
  ADD CONSTRAINT \"Listing_cityId_fkey\" FOREIGN KEY (\"cityId\") REFERENCES \"City\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE \"Listing\"
  ADD CONSTRAINT \"Listing_postalCodeId_fkey\" FOREIGN KEY (\"postalCodeId\") REFERENCES \"PostalCode\"(\"id\") ON DELETE SET NULL ON UPDATE CASCADE;

CREATE INDEX \"Listing_countryId_idx\" ON \"Listing\" (\"countryId\");
CREATE INDEX \"Listing_stateId_idx\" ON \"Listing\" (\"stateId\");
CREATE INDEX \"Listing_cityId_idx\" ON \"Listing\" (\"cityId\");
CREATE INDEX \"Listing_postalCodeId_idx\" ON \"Listing\" (\"postalCodeId\");
EOF" in /var/home/rick/Development/mega-directory succeeded in 47ms:


thinking
**Planning schema and seed updates**

I'm reviewing schema and migration details to ensure indexes, relations, and constraints match between Prisma and SQL. Then I'll focus on designing a new geography seeding script in TypeScript to import datasets with fallback logic for missing states or postal codes. Iâ€™m also planning how to integrate the new seed script with existing seeds, including adding unique constraints to support upserts on PostalCode entries. There is a lot to coordinate across schema, migrations, and seed data to keep everything consistent and reliable.

thinking
**Noticing missing patch format**
file update
M /var/home/rick/Development/mega-directory/db/schema.prisma
@@ -159,2 +159,3 @@
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
apply_patch(auto_approved=true) exited 0 in 7ms:
Success. Updated the following files:
M db/schema.prisma
file update:
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {

file update:
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Updating SQL migration with unique index**
file update
M /var/home/rick/Development/mega-directory/db/migrations/002_location_hierarchy.sql
@@ -96,2 +96,3 @@
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
apply_patch(auto_approved=true) exited 0 in 10ms:
Success. Updated the following files:
M db/migrations/002_location_hierarchy.sql
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {



thinking
**Planning detailed seeding script**

I'm mapping out how to create a seeding script for geographic data with fallback handling for countries lacking postal codes or states. I'll design batch inserts with chunking, use maps to link countries, states, and cities, and dynamically determine presence of postal codes to update flags accordingly. This involves JSON and line-by-line text parsing, normalization, and configurable overrides, aiming for a scalable and robust import despite large datasets.
thinking
**Drafting seed script with sample data and upsert logic**

Iâ€™m outlining the main seed script structure with async functions to load JSON and text datasets, normalize names, and handle error cases. I plan to prepare sample files for countries, states, cities, and postal codes with realistic minimal data, then enhance the main seeding logic to upsert this demo geography. Iâ€™ll integrate these seeds into the existing database seeding flow, carefully coordinating unique IDs to stay consistent and avoid conflicts when loading fuller datasets later.
exec
bash -lc 'unzip -l docs/codex_tasks_detailed_final.zip | head' in /var/home/rick/Development/mega-directory succeeded in 103ms:
Archive:  docs/codex_tasks_detailed_final.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
      460  11-12-2025 05:54   24_setup_project_scaffolding_and_configuration.yaml
      337  11-12-2025 05:54   25_define_directory_page_model_and_metadata_fields.yaml
      310  11-12-2025 05:54   26_implement_directory_page_url_routing_and_subdomain_support.yaml
      185  11-12-2025 05:54   27_add_map_widget_and_listing_pin_features.yaml
      185  11-12-2025 05:54   28_design_country_state_city_postal_schema.yaml
      195  11-12-2025 05:54   29_import_geographic_data_from_external_sources.yaml
      201  11-12-2025 05:54   30_extend_listing_model_with_geographic_references.yaml
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Checking zipped files for datasets**
exec
bash -lc 'unzip -l docs/codex_tasks_bundle.zip | head -n 20' in /var/home/rick/Development/mega-directory succeeded in 50ms:
Archive:  docs/codex_tasks_bundle.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
      764  11-12-2025 06:03   24_setup_project_scaffolding_and_configuration.yaml
      175  11-12-2025 05:40   25_implement_directory_pages_schema.yaml
      197  11-12-2025 05:40   201_user_account_stub_system.yaml
      172  11-12-2025 05:42   26_placeholder_task.yaml
      172  11-12-2025 05:42   27_placeholder_task.yaml
      172  11-12-2025 05:42   28_placeholder_task.yaml
      172  11-12-2025 05:42   29_placeholder_task.yaml
      172  11-12-2025 05:42   30_placeholder_task.yaml
      172  11-12-2025 05:42   31_placeholder_task.yaml
      172  11-12-2025 05:42   32_placeholder_task.yaml
      172  11-12-2025 05:42   33_placeholder_task.yaml
      172  11-12-2025 05:42   34_placeholder_task.yaml
      172  11-12-2025 05:42   35_placeholder_task.yaml
      172  11-12-2025 05:42   36_placeholder_task.yaml
      172  11-12-2025 05:42   37_placeholder_task.yaml
      172  11-12-2025 05:42   38_placeholder_task.yaml
      172  11-12-2025 05:42   39_placeholder_task.yaml
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Preparing sample geographic dataset structure**
exec
bash -lc "mkdir -p db/geography/sample && cat <<'EOF' > db/geography/sample/countries.json
[
  {
    \"id\": 233,
    \"name\": \"United States\",
    \"iso3\": \"USA\",
    \"iso2\": \"US\",
    \"numeric_code\": \"840\",
    \"phone_code\": \"+1\",
    \"capital\": \"Washington D.C.\",
    \"currency\": \"USD\",
    \"currency_name\": \"United States dollar\",
    \"currency_symbol\": \"USD\",
    \"tld\": \".us\",
    \"native\": \"United States\",
    \"region\": \"Americas\",
    \"subregion\": \"Northern America\",
    \"timezones\": [
      {
        \"zoneName\": \"America/New_York\",
        \"gmtOffset\": -18000,
        \"gmtOffsetName\": \"UTC-05:00\",
        \"abbreviation\": \"EST\",
        \"tzName\": \"Eastern Standard Time\"
      }
    ],
    \"translations\": {},
    \"latitude\": \"38.89383800\",
    \"longitude\": \"-77.15466000\",
    \"emoji\": \"ðŸ‡ºðŸ‡¸\",
    \"emojiU\": \"U+1F1FA U+1F1F8\",
    \"wikiDataId\": \"Q30\"
  },
  {
    \"id\": 39,
    \"name\": \"Canada\",
    \"iso3\": \"CAN\",
    \"iso2\": \"CA\",
    \"numeric_code\": \"124\",
    \"phone_code\": \"+1\",
    \"capital\": \"Ottawa\",
    \"currency\": \"CAD\",
    \"currency_name\": \"Canadian dollar\",
    \"currency_symbol\": \"CA"'$",
    "tld": ".ca",
    "native": "Canada",
    "region": "Americas",
    "subregion": "Northern America",
    "timezones": [
      {
        "zoneName": "America/Toronto",
        "gmtOffset": -18000,
        "gmtOffsetName": "UTC-05:00",
        "abbreviation": "EST",
        "tzName": "Eastern Standard Time"
      }
    ],
    "translations": {},
    "latitude": "56.13036600",
    "longitude": "-106.34677100",
    "emoji": "ðŸ‡¨ðŸ‡¦",
    "emojiU": "U+1F1E8 U+1F1E6",
    "wikiDataId": "Q16"
  },
  {
    "id": 229,
    "name": "United Arab Emirates",
    "iso3": "ARE",
    "iso2": "AE",
    "numeric_code": "784",
    "phone_code": "+971",
    "capital": "Abu Dhabi",
    "currency": "AED",
    "currency_name": "United Arab Emirates dirham",
    "currency_symbol": "Ø¯.Ø¥",
    "tld": ".ae",
    "native": "Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©",
    "region": "Asia",
    "subregion": "Western Asia",
    "timezones": [
      {
        "zoneName": "Asia/Dubai",
        "gmtOffset": 14400,
        "gmtOffsetName": "UTC+04:00",
        "abbreviation": "GST",
        "tzName": "Gulf Standard Time"
      }
    ],
    "translations": {},
    "latitude": "24.00000000",
    "longitude": "54.00000000",
    "emoji": "ðŸ‡¦ðŸ‡ª",
    "emojiU": "U+1F1E6 U+1F1EA",
    "wikiDataId": "Q878"
  }
]
EOF' in /var/home/rick/Development/mega-directory succeeded in 49ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Preparing sample states data**
exec
bash -lc "cat <<'EOF' > db/geography/sample/states.json
[
  {
    \"id\": 3930,
    \"name\": \"New York\",
    \"country_id\": 233,
    \"country_code\": \"US\",
    \"country_name\": \"United States\",
    \"state_code\": \"NY\",
    \"type\": \"state\",
    \"latitude\": \"43.29942850\",
    \"longitude\": \"-74.21793260\"
  },
  {
    \"id\": 3876,
    \"name\": \"California\",
    \"country_id\": 233,
    \"country_code\": \"US\",
    \"country_name\": \"United States\",
    \"state_code\": \"CA\",
    \"type\": \"state\",
    \"latitude\": \"36.77826100\",
    \"longitude\": \"-119.41793240\"
  },
  {
    \"id\": 1108,
    \"name\": \"Ontario\",
    \"country_id\": 39,
    \"country_code\": \"CA\",
    \"country_name\": \"Canada\",
    \"state_code\": \"ON\",
    \"type\": \"province\",
    \"latitude\": \"51.25377500\",
    \"longitude\": \"-85.32321390\"
  }
]
EOF" in /var/home/rick/Development/mega-directory succeeded in 49ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Preparing cities.json entries**
exec
bash -lc "cat <<'EOF' > db/geography/sample/cities.json
[
  {
    \"id\": 5128581,
    \"name\": \"New York City\",
    \"ascii_name\": \"New York\",
    \"state_id\": 3930,
    \"state_code\": \"NY\",
    \"state_name\": \"New York\",
    \"country_id\": 233,
    \"country_code\": \"US\",
    \"country_name\": \"United States\",
    \"latitude\": \"40.71277530\",
    \"longitude\": \"-74.00597280\",
    \"wikiDataId\": \"Q60\"
  },
  {
    \"id\": 5391959,
    \"name\": \"San Francisco\",
    \"ascii_name\": \"San Francisco\",
    \"state_id\": 3876,
    \"state_code\": \"CA\",
    \"state_name\": \"California\",
    \"country_id\": 233,
    \"country_code\": \"US\",
    \"country_name\": \"United States\",
    \"latitude\": \"37.77492950\",
    \"longitude\": \"-122.41941550\",
    \"wikiDataId\": \"Q62\"
  },
  {
    \"id\": 6167865,
    \"name\": \"Toronto\",
    \"ascii_name\": \"Toronto\",
    \"state_id\": 1108,
    \"state_code\": \"ON\",
    \"state_name\": \"Ontario\",
    \"country_id\": 39,
    \"country_code\": \"CA\",
    \"country_name\": \"Canada\",
    \"latitude\": \"43.65107000\",
    \"longitude\": \"-79.34701500\",
    \"wikiDataId\": \"Q172\"
  },
  {
    \"id\": 292223,
    \"name\": \"Dubai\",
    \"ascii_name\": \"Dubai\",
    \"state_id\": null,
    \"state_code\": null,
    \"state_name\": null,
    \"country_id\": 229,
    \"country_code\": \"AE\",
    \"country_name\": \"United Arab Emirates\",
    \"latitude\": \"25.27698700\",
    \"longitude\": \"55.29624900\",
    \"wikiDataId\": \"Q613\"
  }
]
EOF" in /var/home/rick/Development/mega-directory succeeded in 58ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Identifying missing sample file**
exec
bash -lc "cat <<'EOF' > db/geography/sample/postal_codes.txt
US	10004	New York City	New York	NY	New York County	061			40.688400	-74.017000	1
US	94105	San Francisco	California	CA	San Francisco County	075			37.789800	-122.394200	1
CA	M5H	Toronto	Ontario	ON	Toronto Division	3520			43.650200	-79.384900	1
EOF" in /var/home/rick/Development/mega-directory succeeded in 41ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Designing geography seed script and README**

I'm laying out plans for a comprehensive TypeScript seed script to import geography data into the database, handling countries, states, cities, and postal codes with batching, mapping, and error handling. Along with the script, I intend to create a detailed README describing dataset sources, environment variables, and usage instructions once the script exists to keep everything aligned.
exec
bash -lc "mkdir -p db/scripts && cat <<'EOF' > db/scripts/seedGeography.ts
import fs from 'node:fs';
import path from 'node:path';
import readline from 'node:readline';
import { promises as fsp } from 'node:fs';
import { PrismaClient, Prisma } from '@prisma/client';

type CountryJsonRecord = {
  id: number;
  name: string;
  iso2: string;
  iso3?: string | null;
  numeric_code?: string | null;
  phone_code?: string | null;
  capital?: string | null;
  currency?: string | null;
  currency_name?: string | null;
  currency_symbol?: string | null;
  tld?: string | null;
  native?: string | null;
  region?: string | null;
  subregion?: string | null;
  translations?: unknown;
  timezones?: unknown;
  latitude?: string | number | null;
  longitude?: string | number | null;
  emoji?: string | null;
  emojiU?: string | null;
  wikiDataId?: string | null;
};

type StateJsonRecord = {
  id: number;
  name: string;
  country_id: number;
  country_code: string;
  country_name?: string;
  state_code?: string | null;
  type?: string | null;
  latitude?: string | number | null;
  longitude?: string | number | null;
};

type CityJsonRecord = {
  id: number;
  name: string;
  ascii_name?: string | null;
  state_id?: number | null;
  state_code?: string | null;
  state_name?: string | null;
  country_id: number;
  country_code: string;
  country_name?: string;
  latitude?: string | number | null;
  longitude?: string | number | null;
  wikiDataId?: string | null;
  population?: number | null;
  timezone?: string | null;
};

type PostalRow = {
  countryCode: string;
  postalCode: string;
  placeName: string;
  stateName?: string | null;
  stateCode?: string | null;
  countyName?: string | null;
  countyCode?: string | null;
  cityName?: string | null;
  latitude?: string | null;
  longitude?: string | null;
  accuracy?: string | null;
};

type SeedPaths = {
  datasetDir: string;
  countriesFile: string;
  statesFile: string;
  citiesFile: string;
  postalFile: string;
};

type SeedSummary = {
  countries: number;
  states: number;
  cities: number;
  postalCodes: number;
};

type StateLookup = {
  byCode: Map<string, number>;
  byName: Map<string, number>;
};

type CityLookup = {
  byCountryStateAndName: Map<string, number>;
  byCountryAndName: Map<string, number>;
};

const prisma = new PrismaClient();
const DEFAULT_DATASET_DIR = path.resolve(__dirname, '../geography/sample');
const DATASET_DIR = path.resolve(process.env.GEO_DATASET_DIR ?? DEFAULT_DATASET_DIR);
const POSTAL_FILE_OVERRIDE = process.env.GEO_POSTAL_FILE
  ? path.resolve(process.env.GEO_POSTAL_FILE)
  : undefined;
const CREATE_BATCH_SIZE = parseEnvInt('GEO_CREATE_BATCH_SIZE', 500);
const POSTAL_BATCH_SIZE = parseEnvInt('GEO_POSTAL_BATCH_SIZE', 2000);

async function main() {
  const summary: SeedSummary = { countries: 0, states: 0, cities: 0, postalCodes: 0 };

  try {
    const paths = await resolvePaths();
    console.info('[geo-seed] Using dataset directory:', paths.datasetDir);
    const [countryJson, stateJson, cityJson] = await Promise.all([
      readJsonFile<CountryJsonRecord[]>(paths.countriesFile),
      readJsonFile<StateJsonRecord[]>(paths.statesFile),
      readJsonFile<CityJsonRecord[]>(paths.citiesFile)
    ]);

    const allCountryIds = new Set(countryJson.map((record) => record.id));
    const isoToCountryId = new Map(countryJson.map((record) => [record.iso2.toUpperCase(), record.id]));

    summary.countries = countryJson.length;
    await seedCountries(countryJson);

    const { stateLookup, countriesWithStates } = await seedStates(stateJson);
    summary.states = stateJson.length;

    const cityLookup = await seedCities(cityJson);
    summary.cities = cityJson.length;

    const postalStats = await seedPostalCodes(paths.postalFile, {
      isoToCountryId,
      stateLookup,
      cityLookup
    });
    summary.postalCodes = postalStats.processed;

    await updateCountryFlags({
      allCountryIds,
      countriesWithStates,
      countriesWithPostalCodes: postalStats.countriesWithPostalCodes
    });

    console.info('[geo-seed] Completed geographic bootstrap', summary);
  } catch (error) {
    console.error('[geo-seed] Failed to seed geography', error);
    process.exitCode = 1;
  } finally {
    await prisma."'$disconnect();
  }
}

async function resolvePaths(): Promise<SeedPaths> {
  const datasetDir = DATASET_DIR;
  const countriesFile = path.join(datasetDir, '"'countries.json');
  const statesFile = path.join(datasetDir, 'states.json');
  const citiesFile = path.join(datasetDir, 'cities.json');
  const postalFile = POSTAL_FILE_OVERRIDE ?? path.join(datasetDir, 'postal_codes.txt');

  await Promise.all([
    ensureFile(countriesFile),
    ensureFile(statesFile),
    ensureFile(citiesFile),
    ensureFile(postalFile)
  ]);

  return { datasetDir, countriesFile, statesFile, citiesFile, postalFile };
}

async function ensureFile(filePath: string): Promise<void> {
  try {
    await fsp.access(filePath, fs.constants.R_OK);
  } catch (error) {
    throw new Error("'`Required dataset file not found at ${filePath}`);
  }
}

async function readJsonFile<T>(filePath: string): Promise<T> {
  const raw = await fsp.readFile(filePath, '"'utf8');
  return JSON.parse(raw) as T;
}

async function seedCountries(records: CountryJsonRecord[]): Promise<void> {
  const batchInputs: Prisma.CountryCreateManyInput[] = records.map((country) => ({
    id: country.id,
    name: country.name,
    iso2: country.iso2.toUpperCase(),
    iso3: sanitizeString(country.iso3),
    numericCode: sanitizeString(country.numeric_code),
    phoneCode: sanitizeString(country.phone_code),
    capital: sanitizeString(country.capital),
    currency: sanitizeString(country.currency),
    currencyName: sanitizeString(country.currency_name),
    currencySymbol: sanitizeString(country.currency_symbol),
    tld: sanitizeString(country.tld),
    nativeName: sanitizeString(country.native),
    region: sanitizeString(country.region),
    subregion: sanitizeString(country.subregion),
    translations: country.translations ?? Prisma.JsonNull,
    timezones: country.timezones ?? Prisma.JsonNull,
    latitude: toFloat(country.latitude),
    longitude: toFloat(country.longitude),
    emoji: sanitizeString(country.emoji),
    emojiU: sanitizeString(country.emojiU),
    wikiDataId: sanitizeString(country.wikiDataId),
    hasStates: true,
    hasPostalCodes: true
  }));

  await chunkedCreateMany(batchInputs, async (chunk) => {
    await prisma.country.createMany({ data: chunk, skipDuplicates: true });
  });
}

async function seedStates(records: StateJsonRecord[]): Promise<{
  stateLookup: StateLookup;
  countriesWithStates: Set<number>;
}> {
  const byCode = new Map<string, number>();
  const byName = new Map<string, number>();
  const countriesWithStates = new Set<number>();

  const inputs: Prisma.StateProvinceCreateManyInput[] = records.map((state) => {
    const countryCode = state.country_code.toUpperCase();
    const codeKey = buildStateCodeKey(countryCode, state.state_code);
    if (codeKey) {
      byCode.set(codeKey, state.id);
    }
    const nameKey = buildStateNameKey(countryCode, state.name);
    if (nameKey) {
      byName.set(nameKey, state.id);
    }
    countriesWithStates.add(state.country_id);

    return {
      id: state.id,
      name: state.name,
      stateCode: sanitizeString(state.state_code),
      type: sanitizeString(state.type),
      latitude: toFloat(state.latitude),
      longitude: toFloat(state.longitude),
      countryId: state.country_id,
      countryCode
    } satisfies Prisma.StateProvinceCreateManyInput;
  });

  await chunkedCreateMany(inputs, async (chunk) => {
    await prisma.stateProvince.createMany({ data: chunk, skipDuplicates: true });
  });

  return { stateLookup: { byCode, byName }, countriesWithStates };
}

async function seedCities(records: CityJsonRecord[]): Promise<CityLookup> {
  const byCountryStateAndName = new Map<string, number>();
  const byCountryAndName = new Map<string, number>();

  const inputs: Prisma.CityCreateManyInput[] = records.map((city) => {
    const countryCode = city.country_code.toUpperCase();
    const stateCode = sanitizeString(city.state_code);
    const normalizedKey = buildCityKey(countryCode, stateCode, city.name);
    if (normalizedKey) {
      byCountryStateAndName.set(normalizedKey, city.id);
    }
    const fallbackKey = buildCityKey(countryCode, null, city.name);
    if (fallbackKey) {
      byCountryAndName.set(fallbackKey, city.id);
    }

    return {
      id: city.id,
      name: city.name,
      asciiName: sanitizeString(city.ascii_name),
      latitude: toFloat(city.latitude),
      longitude: toFloat(city.longitude),
      population: city.population ?? null,
      timezone: sanitizeString(city.timezone),
      wikiDataId: sanitizeString(city.wikiDataId),
      stateId: city.state_id ?? null,
      stateCode,
      stateName: sanitizeString(city.state_name),
      countryId: city.country_id,
      countryCode
    } satisfies Prisma.CityCreateManyInput;
  });

  await chunkedCreateMany(inputs, async (chunk) => {
    await prisma.city.createMany({ data: chunk, skipDuplicates: true });
  });

  return { byCountryStateAndName, byCountryAndName };
}

async function seedPostalCodes(
  postalFile: string,
  lookups: {
    isoToCountryId: Map<string, number>;
    stateLookup: StateLookup;
    cityLookup: CityLookup;
  }
): Promise<{ processed: number; countriesWithPostalCodes: Set<number> }> {
  if ("'!fs.existsSync(postalFile)) {
    throw new Error(`Postal code dataset missing at ${postalFile}`);
  }

  const countriesWithPostalCodes = new Set<number>();
  const batch: Prisma.PostalCodeCreateManyInput[] = [];
  const stream = fs.createReadStream(postalFile);
  const rl = readline.createInterface({ input: stream, crlfDelay: Infinity });
  let processed = 0;

  for await (const line of rl) {
    if (!line || line.startsWith('"'#')) {
      continue;
    }
    const row = parsePostalLine(line);
    if ("'!row) {
      continue;
    }
    const countryId = lookups.isoToCountryId.get(row.countryCode.toUpperCase());
    if (!countryId) {
      continue;
    }

    const stateId = resolveStateId(row, lookups.stateLookup);
    const cityId = resolveCityId(row, lookups.cityLookup);

    batch.push({
      code: row.postalCode,
      placeName: row.placeName,
      countryId,
      countryCode: row.countryCode.toUpperCase(),
      stateId,
      stateCode: sanitizeString(row.stateCode),
      stateName: sanitizeString(row.stateName),
      countyName: sanitizeString(row.countyName),
      countyCode: sanitizeString(row.countyCode),
      cityId,
      latitude: toFloat(row.latitude),
      longitude: toFloat(row.longitude),
      accuracy: toInteger(row.accuracy)
    });
    processed += 1;
    countriesWithPostalCodes.add(countryId);

    if (batch.length >= POSTAL_BATCH_SIZE) {
      await prisma.postalCode.createMany({ data: batch, skipDuplicates: true });
      batch.length = 0;
    }
  }

  if (batch.length > 0) {
    await prisma.postalCode.createMany({ data: batch, skipDuplicates: true });
  }

  return { processed, countriesWithPostalCodes };
}

async function updateCountryFlags(params: {
  allCountryIds: Set<number>;
  countriesWithStates: Set<number>;
  countriesWithPostalCodes: Set<number>;
}): Promise<void> {
  const { allCountryIds, countriesWithStates, countriesWithPostalCodes } = params;
  const withStates = Array.from(countriesWithStates);
  if (withStates.length > 0) {
    await prisma.country.updateMany({
      data: { hasStates: true },
      where: { id: { in: withStates } }
    });
  }
  const withoutStates = Array.from(allCountryIds).filter((id) => !countriesWithStates.has(id));
  if (withoutStates.length > 0) {
    await prisma.country.updateMany({
      data: { hasStates: false },
      where: { id: { in: withoutStates } }
    });
  }

  const withPostal = Array.from(countriesWithPostalCodes);
  if (withPostal.length > 0) {
    await prisma.country.updateMany({
      data: { hasPostalCodes: true },
      where: { id: { in: withPostal } }
    });
  }
  const withoutPostal = Array.from(allCountryIds).filter((id) => !countriesWithPostalCodes.has(id));
  if (withoutPostal.length > 0) {
    await prisma.country.updateMany({
      data: { hasPostalCodes: false },
      where: { id: { in: withoutPostal } }
    });
  }
}

function resolveStateId(row: PostalRow, lookup: StateLookup): number | null {
  if (row.stateCode) {
    const codeKey = buildStateCodeKey(row.countryCode.toUpperCase(), row.stateCode);
    const codeMatch = codeKey ? lookup.byCode.get(codeKey) : undefined;
    if (codeMatch) {
      return codeMatch;
    }
  }
  if (row.stateName) {
    const nameKey = buildStateNameKey(row.countryCode.toUpperCase(), row.stateName);
    const nameMatch = nameKey ? lookup.byName.get(nameKey) : undefined;
    if (nameMatch) {
      return nameMatch;
    }
  }
  return null;
}

function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
  const normalizedName = normalizeName(row.cityName ?? row.placeName);
  if (!normalizedName) {
    return null;
  }
  const stateCode = sanitizeString(row.stateCode);
  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
  if (key) {
    const exact = lookup.byCountryStateAndName.get(key);
    if (exact) {
      return exact;
    }
  }
  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
  if (fallbackKey) {
    const fallback = lookup.byCountryAndName.get(fallbackKey);
    if (fallback) {
      return fallback;
    }
  }
  return null;
}

function parsePostalLine(line: string): PostalRow | null {
  const parts = line.split('"'\\t');
  if (parts.length < 4) {
    return null;
  }
  return {
    countryCode: parts[0],
    postalCode: parts[1],
    placeName: parts[2],
    stateName: parts[3] || null,
    stateCode: parts[4] || null,
    countyName: parts[5] || null,
    countyCode: parts[6] || null,
    cityName: parts[2],
    latitude: parts[9] || null,
    longitude: parts[10] || null,
    accuracy: parts[11] || null
  };
}

function sanitizeString(value?: string | null): string | null {
  if (value === null || value === undefined) {
    return null;
  }
  const trimmed = "'`${value}`.trim();
  return trimmed.length > 0 ? trimmed : null;
}

function toFloat(value?: string | number | null): number | null {
  if (value === null || value === undefined) {
    return null;
  }
  const numeric = typeof value === '"'number' ? value : Number.parseFloat(value);
  return Number.isFinite(numeric) ? numeric : null;
}

function toInteger(value?: string | null): number | null {
  if ("'!value) {
    return null;
  }
  const parsed = Number.parseInt(value, 10);
  return Number.isNaN(parsed) ? null : parsed;
}

function parseEnvInt(key: string, fallback: number): number {
  const raw = process.env[key];
  if (!raw) {
    return fallback;
  }
  const parsed = Number.parseInt(raw, 10);
  return Number.isFinite(parsed) && parsed > 0 ? parsed : fallback;
}

async function chunkedCreateMany<T>(records: T[], handler: (chunk: T[]) => Promise<void>): Promise<void> {
  for (let index = 0; index < records.length; index += CREATE_BATCH_SIZE) {
    const chunk = records.slice(index, index + CREATE_BATCH_SIZE);
    if (chunk.length === 0) {
      continue;
    }
    await handler(chunk);
  }
}

function buildStateCodeKey(countryCode: string, stateCode?: string | null): string | null {
  const normalizedCode = sanitizeString(stateCode);
  if (!normalizedCode) {
    return null;
  }
  return `${countryCode.toUpperCase()}::${normalizedCode.toUpperCase()}`;
}

function buildStateNameKey(countryCode: string, name?: string | null): string | null {
  const normalizedName = normalizeName(name);
  if (!normalizedName) {
    return null;
  }
  return `${countryCode.toUpperCase()}::${normalizedName}`;
}

function buildCityKey(countryCode: string, stateCode: string | null, name?: string | null): string | null {
  const normalizedName = normalizeName(name);
  if (!normalizedName) {
    return null;
  }
  const statePart = stateCode ? stateCode.toUpperCase() : '"'*';
  return "'`${countryCode.toUpperCase()}::${statePart}::${normalizedName}`;
}

function normalizeName(value?: string | null): string {
  if (!value) {
    return '"'';
  }
  return value
    .trim()
    .toLowerCase()
    .replace(/["'^a-z0-9]+/g, '"' ')
    .replace(/\\s+/g, ' ')
    .trim();
}

void main();
EOF" in /var/home/rick/Development/mega-directory succeeded in 45ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {


thinking
**Verifying data normalization and typings**
file update
M /var/home/rick/Development/mega-directory/db/scripts/seedGeography.ts
@@ -415,8 +415,4 @@
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
@@ -427,3 +423,3 @@
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M db/scripts/seedGeography.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {


thinking
**Inserting geography helper and planning seed updates**

I'm preparing to add an `ensureDemoGeography` helper function in `db/seed.ts` to upsert demo countries, states, cities, and postal codes, then update the main seeding flow to reference this data for location and listing records. I'll carefully patch the file near the Prisma client initialization and before `main()`, adjusting upserts to use the new foreign keys and maintain data integrity throughout seeding.
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -4,2 +4,227 @@
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
apply_patch(auto_approved=true) exited 0 in 13ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..b03a2ce563f721f69242764cc64096a1cf6ffa56
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,6 +2,231 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..b03a2ce563f721f69242764cc64096a1cf6ffa56
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,6 +2,231 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },


thinking
**Preparing to update main function**
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -230,2 +230,3 @@
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
@@ -274,3 +275,9 @@
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
@@ -286,3 +293,9 @@
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
apply_patch(auto_approved=true) exited 0 in 11ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8f93e0c3e8406cb74e544634250a62d58830230e
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8f93e0c3e8406cb74e544634250a62d58830230e
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 


thinking
**Preparing listing creation updates**
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -449,3 +449,7 @@
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
apply_patch(auto_approved=true) exited 0 in 11ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..261b4a8bca235401f4beb8149c0b5ba2f78342d3
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..261b4a8bca235401f4beb8149c0b5ba2f78342d3
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Locating harborListing block**
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -497,2 +497,6 @@
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
@@ -509,3 +513,7 @@
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..fc3d33d8ac206a000f9ea0b7d2575143fd491687
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +495,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +511,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..fc3d33d8ac206a000f9ea0b7d2575143fd491687
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +495,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +511,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Updating steadfastListing block**
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -547,2 +547,6 @@
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
@@ -559,3 +563,7 @@
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
apply_patch(auto_approved=true) exited 0 in 13ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..1d025c243dc76ab493db66c31024dedb0ca41f42
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +495,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +511,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +545,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +561,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..1d025c243dc76ab493db66c31024dedb0ca41f42
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -47,7 +273,13 @@
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -59,7 +291,13 @@
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +447,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +495,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +511,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +545,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +561,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Updating location upsert logic**
file update
M /var/home/rick/Development/mega-directory/db/seed.ts
@@ -269,3 +269,13 @@
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
@@ -287,3 +297,13 @@
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M db/seed.ts
file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Verifying geography data consistency and documentation**

I'm ensuring all geography-related entities like NYC and SF have consistent fields set, including lat/long and associations with directory and jobs data. I'll also make sure TypeScript typings and seed scripts align, then add a README in `db/geography` documenting the geographic seed data, dataset sources, environment variables, and usage instructions for the seeding scripts.
exec
bash -lc "cat <<'EOF' > db/geography/README.md
# Geographic Seed Data

This directory documents the reference datasets that back the global location
hierarchy (countries â†’ states/provinces â†’ cities â†’ postal codes). The actual
data remains outside the repository to keep the repo lightweight and to respect
the licenses of the original providers.

## Required Sources

| Dataset | Source | Notes |
| --- | --- | --- |
| Countries/States/Cities | ["'`dr5hn/countries-states-cities-database`](https://github.com/dr5hn/countries-states-cities-database) | Download the JSON release (`countries.json`, `states.json`, `cities.json`). |
| Postal Codes | [GeoNames Postal Code files](https://download.geonames.org/export/zip/) | Either download the full `allCountries.zip` and extract the `.txt` file or combine selected country files. |

Place the extracted files anywhere on disk and point the seed script to the
folder via the environment variables shown below. For quick smoke tests (and to
keep CI fast) the repo ships with the `sample/` subset that contains only a few
entries for the United States, Canada, and the United Arab Emirates.

## Running the Seeder

The Prisma-aware loader lives at `db/scripts/seedGeography.ts`. Run it with
`ts-node` (or your preferred TypeScript runner) once the database connection is
configured:

```bash
# Uses the bundled sample data
npx ts-node db/scripts/seedGeography.ts

# Point to the full dataset dump
GEO_DATASET_DIR="$HOME/datasets/geography" '"\\
GEO_POSTAL_FILE=\""'$HOME/datasets/geography/allCountries.txt" '"\\
npx ts-node db/scripts/seedGeography.ts
"'```

### Environment Variables

- `GEO_DATASET_DIR` â€“ directory containing `countries.json`, `states.json`, and
  `cities.json`. Defaults to `db/geography/sample`.
- `GEO_POSTAL_FILE` â€“ absolute path to the GeoNames `.txt` file. Defaults to a
  file named `postal_codes.txt` inside `GEO_DATASET_DIR`.
- `GEO_CREATE_BATCH_SIZE` â€“ optional batch size for Prisma `createMany`
  operations (default `500`).
- `GEO_POSTAL_BATCH_SIZE` â€“ optional batch size for streaming postal inserts
  (default `2000`).

### Postal-Code-Less Countries & Fallbacks

Some countries do not issue postal codes. The seeding script automatically
tracks which countries received postal-code rows and marks `Country.hasPostalCodes`
accordingly. Countries with zero state/province entries are similarly marked via
`hasStates`, ensuring downstream application logic can fall back to city-level
filters.

## Sample Dataset

The `sample/` directory mirrors the schema of the upstream JSON/TXT files but
only includes a handful of records so tests can run quickly without the full
2GB+ datasets.
EOF' in /var/home/rick/Development/mega-directory succeeded in 47ms:

file update:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Documenting geographic seed data in README**
file update
M /var/home/rick/Development/mega-directory/README.md
@@ -36,2 +36,18 @@
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
apply_patch(auto_approved=true) exited 0 in 13ms:
Success. Updated the following files:
M README.md
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..3d11a273a80bb623c40fe59381d351869feba1b3
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Verifying TypeScript script and data types**
file update
M /var/home/rick/Development/mega-directory/db/scripts/seedGeography.ts
@@ -55,3 +55,3 @@
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
apply_patch(auto_approved=true) exited 0 in 15ms:
Success. Updated the following files:
M db/scripts/seedGeography.ts
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..08c211774f10f0cf36d703759c9a544e4a9a1bf8
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..08c211774f10f0cf36d703759c9a544e4a9a1bf8
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Adjusting toInteger helper and seedCities population**
file update
M /var/home/rick/Development/mega-directory/db/scripts/seedGeography.ts
@@ -276,3 +276,3 @@
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
apply_patch(auto_approved=true) exited 0 in 14ms:
Success. Updated the following files:
M db/scripts/seedGeography.ts
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..5cc07925c3ec9c4aad49333c9c3c611a23885062
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..5cc07925c3ec9c4aad49333c9c3c611a23885062
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Updating toInteger function**
file update
M /var/home/rick/Development/mega-directory/db/scripts/seedGeography.ts
@@ -469,7 +469,7 @@
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M db/scripts/seedGeography.ts
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Verifying and setting geographic data fields**
exec
bash -lc 'rg -n "county" -n db/schema.prisma' in /var/home/rick/Development/mega-directory succeeded in 45ms:
143:  countyName  String?
144:  countyCode  String?
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Verifying SQL migration columns**
exec
bash -lc "sed -n '60,160p' db/migrations/002_location_hierarchy.sql" in /var/home/rick/Development/mega-directory succeeded in 42ms:
  "stateCode" TEXT,
  "stateName" TEXT,
  "countryId" INTEGER NOT NULL,
  "countryCode" TEXT NOT NULL,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT "City_countryId_fkey" FOREIGN KEY ("countryId") REFERENCES "Country"("id") ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT "City_stateId_fkey" FOREIGN KEY ("stateId") REFERENCES "StateProvince"("id") ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE INDEX "City_countryId_idx" ON "City" ("countryId");
CREATE INDEX "City_stateId_idx" ON "City" ("stateId");

CREATE TABLE "PostalCode" (
  "id" SERIAL PRIMARY KEY,
  "code" TEXT NOT NULL,
  "placeName" TEXT NOT NULL,
  "countryId" INTEGER NOT NULL,
  "countryCode" TEXT NOT NULL,
  "stateId" INTEGER,
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Verifying database script and setup requirements**
exec
bash -lc 'git status -sb' in /var/home/rick/Development/mega-directory succeeded in 42ms:
## main...origin/main [ahead 3]
 M .env.example
 M README.md
 M db/schema.prisma
 M db/seed.ts
?? .editorconfig
?? .vscode/
?? apps/
?? codex/LOGS/codex_run_2025-11-12_06-13-21.log
?? codex/LOGS/tasklog_24_setup_project_scaffolding_and_configuration_1762946001.log
?? codex/LOGS/tasklog_24_setup_project_scaffolding_and_configuration_1762946001.log.done
?? codex/LOGS/tasklog_25_define_directory_page_model_and_metadata_fields_1762949245.log
?? codex/LOGS/tasklog_25_define_directory_page_model_and_metadata_fields_1762949245.log.done
?? codex/LOGS/tasklog_25a_initialize_astro_frontend_with_base_layouts_1762948216.log
?? codex/LOGS/tasklog_25a_initialize_astro_frontend_with_base_layouts_1762948216.log.done
?? codex/LOGS/tasklog_26_initialize_geographic_location_tables_and_seed_data_1762949750.log
?? codex/TASKS/work_list
?? db/geography/
?? db/migrations/002_location_hierarchy.sql
?? db/scripts/
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Assessing repository state and plan progress**
Plan update
  âœ“ Analyze task requirements and existing database setup for location data.
  âœ“ Implement schema + migration changes for country/state/city/postal hierarchy with fallbacks.
  âœ“ Add seeding utilities + fixtures referencing public datasets and wire samples into existing seeds.
  â†’ Run available tests and summarize results.
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Preparing to run tests**
exec
bash -lc 'npm test' in /var/home/rick/Development/mega-directory succeeded in 5.30s:

> mega-directory@0.1.0 test
> npm run test --workspaces --if-present


> mega-directory-admin@0.1.0 test
> node --test

TAP version 13
# Subtest: test/categoryLocationService.test.js
ok 1 - test/categoryLocationService.test.js
  ---
  duration_ms: 181.521526
  type: 'test'
  ...
# Subtest: test/listingsService.test.js
ok 2 - test/listingsService.test.js
  ---
  duration_ms: 178.300704
  type: 'test'
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Marking Step4 as completed**
Plan update
  âœ“ Analyze task requirements and existing database setup for location data.
  âœ“ Implement schema + migration changes for country/state/city/postal hierarchy with fallbacks.
  âœ“ Add seeding utilities + fixtures referencing public datasets and wire samples into existing seeds.
  âœ“ Run available tests and summarize results.
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Preparing detailed summary with file references**
exec
bash -lc "nl -ba db/schema.prisma | sed -n '1,200p'" in /var/home/rick/Development/mega-directory succeeded in 48ms:
     1	generator client {
     2	  provider = "prisma-client-js"
     3	}
     4	
     5	
     6	
     7	datasource db {
     8	  provider = "postgresql"
     9	  url      = env("DATABASE_URL")
    10	}
    11	
    12	enum ListingStatus {
    13	  PENDING
    14	  APPROVED
    15	  REJECTED
    16	  INACTIVE
    17	}
    18	
    19	enum DirectoryStatus {
    20	  DRAFT
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Identifying line numbers for Listing modifications**
exec
bash -lc "nl -ba db/schema.prisma | sed -n '200,400p'" in /var/home/rick/Development/mega-directory succeeded in 44ms:
   200	  stateRecord      StateProvince? @relation("StateLocations", fields: [stateId], references: [id])
   201	  cityRecord       City?          @relation("CityLocations", fields: [cityId], references: [id])
   202	  postalCodeRecord PostalCode?    @relation("PostalCodeLocations", fields: [postalCodeId], references: [id])
   203	
   204	  listings    Listing[]
   205	  directories Directory[]
   206	
   207	  @@index([countryId])
   208	  @@index([stateId])
   209	  @@index([cityId])
   210	  @@index([postalCodeId])
   211	}
   212	
   213	model Directory {
   214	  id              Int             @id @default(autoincrement())
   215	  title           String
   216	  slug            String          @unique
   217	  subdomain       String          @unique
   218	  subdirectory    String          @unique
   219	  hostname        String?
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Planning detailed file references**
exec
bash -lc "nl -ba db/seed.ts | sed -n '1,200p'" in /var/home/rick/Development/mega-directory succeeded in 43ms:
     1	import { PrismaClient } from '@prisma/client';
     2	
     3	const prisma = new PrismaClient();
     4	
     5	async function ensureDemoGeography() {
     6	  const unitedStates = await prisma.country.upsert({
     7	    where: { id: 233 },
     8	    update: {
     9	      name: 'United States',
    10	      iso2: 'US',
    11	      iso3: 'USA',
    12	      numericCode: '840',
    13	      phoneCode: '+1',
    14	      capital: 'Washington D.C.',
    15	      currency: 'USD',
    16	      currencyName: 'United States dollar',
    17	      currencySymbol: '$',
    18	      region: 'Americas',
    19	      subregion: 'Northern America',
    20	      timezones: [
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Continuing file exploration for line references**
exec
bash -lc "nl -ba db/seed.ts | sed -n '200,400p'" in /var/home/rick/Development/mega-directory succeeded in 41ms:
   200	      placeName: 'San Francisco',
   201	      countryId: unitedStates.id,
   202	      countryCode: 'US',
   203	      stateId: californiaState.id,
   204	      stateCode: 'CA',
   205	      stateName: 'California',
   206	      cityId: sfCity.id,
   207	      latitude: 37.7898,
   208	      longitude: -122.3942,
   209	      accuracy: 1
   210	    }
   211	  });
   212	
   213	  return {
   214	    country: unitedStates,
   215	    states: {
   216	      ny: newYorkState,
   217	      ca: californiaState
   218	    },
   219	    cities: {
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Searching for listing line numbers**
exec
bash -lc 'rg -n "Bright Sparks" -n db/seed.ts' in /var/home/rick/Development/mega-directory succeeded in 43ms:
442:      title: 'Bright Sparks Electric Co.',
447:        'Bright Sparks Electric specializes in large-scale tenant improvements, structured wiring, and EV charger installs. Technicians hold NABCEP and UL certifications.',
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Checking line numbers for references**
exec
bash -lc 'rg -n "Geographic Seed Data" README.md' in /var/home/rick/Development/mega-directory succeeded in 45ms:
37:### Geographic Seed Data
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Organizing update summary structure**
exec
bash -lc 'rg -n "updateCountryFlags" -n db/scripts/seedGeography.ts' in /var/home/rick/Development/mega-directory succeeded in 41ms:
139:    await updateCountryFlags({
360:async function updateCountryFlags(params: {
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 


thinking
**Compiling detailed file references and summary points**
codex
**Database & Models**
- Added normalized geographic hierarchy models plus foreign-key back-references so listings/locations can bind directly to countries, states, cities, and postal codes (`db/schema.prisma:51`, `db/schema.prisma:85`, `db/schema.prisma:107`, `db/schema.prisma:134`, `db/schema.prisma:180`, `db/schema.prisma:265`).
- Introduced migration `002_location_hierarchy.sql` to create the new tables, compound indexes, and FK columns on `Location`/`Listing`, ensuring those relationships exist at the SQL layer as well (`db/migrations/002_location_hierarchy.sql:1`).
- Seed script now bootstraps canonical U.S. geography so the demo data has consistent foreign-key coverage; locations and listings link to the new entities and carry accurate lat/long/ZIP metadata (`db/seed.ts:5`, `db/seed.ts:268`, `db/seed.ts:442`).

**Geography Seeder & Docs**
- Implemented `db/scripts/seedGeography.ts` to load the dr5hn + GeoNames datasets with chunked `createMany` calls, stream postal data, and automatically flip `hasStates`/`hasPostalCodes` flags for countries lacking coverage (`db/scripts/seedGeography.ts:1`, `db/scripts/seedGeography.ts:360`).
- Documented how to obtain/place the upstream datasets and wired lightweight fixtures under `db/geography/sample/` so tests can run without the multi-GB exports (`db/geography/README.md:1`, `db/geography/sample/countries.json:1`).
- README now describes how to execute the new geography seed with either the bundled sample or full datasets, including the relevant environment variables (`README.md:37`).

**Tests**
- `npm test` (root)
file update:
diff --git a/README.md b/README.md
index 0dc5414737f31bf64abe0fe85b8378cad483ea26..e3c995f52f4c0b67e2fe183a1751b7d7d364592d
--- a/README.md
+++ b/README.md
@@ -34,6 +34,22 @@
 
 Database schema and seed scripts live under `/db`. Run Prisma/DB commands from the `apps/api` workspace once the API server has been configured with a connection string (see future Codex tasks for details). Shared constants (ports, labels, etc.) live in `packages/shared-config` and are linked into each app automatically.
 
+### Geographic Seed Data
+
+The global hierarchy for countries, states/provinces, cities, and postal codes
+is populated with `db/scripts/seedGeography.ts`. By default the script loads the
+small fixtures under `db/geography/sample`, but you can point it at the full
+datasets from the dr5hn and GeoNames projects:
+
+```bash
+GEO_DATASET_DIR="$HOME/datasets/geography" \
+GEO_POSTAL_FILE="$HOME/datasets/geography/allCountries.txt" \
+npx ts-node db/scripts/seedGeography.ts
+```
+
+See `db/geography/README.md` for the expected file layout, batching controls,
+and notes about countries that do not issue postal codes.
+
 ## Running with Docker Compose
 
 `docker-compose.yml` defines only the core platform services: `api`, `db`, and the Astro-powered `web` frontend. Bring them up together with:
diff --git a/db/migrations/002_location_hierarchy.sql b/db/migrations/002_location_hierarchy.sql
index 880a0e7aa570ad84ce584076a9420140d834b1ac..d59fc6a732a1c25f0e6b69e0dce1aa2587bfd0cc
--- a/db/migrations/002_location_hierarchy.sql
+++ b/db/migrations/002_location_hierarchy.sql
@@ -94,6 +94,7 @@
 
 CREATE INDEX "PostalCode_country_code_idx" ON "PostalCode" ("countryId", "code");
 CREATE INDEX "PostalCode_cityId_idx" ON "PostalCode" ("cityId");
+CREATE UNIQUE INDEX "PostalCode_country_code_place_key" ON "PostalCode" ("countryId", "code", "placeName");
 
 ALTER TABLE "Location"
   ADD COLUMN "countryId" INTEGER,
diff --git a/db/schema.prisma b/db/schema.prisma
index bb44e1e9236fa5912d83937f14f9326707028857..bc4a239413fd3bcc704aa5d4ab21beb2e3e1012b
--- a/db/schema.prisma
+++ b/db/schema.prisma
@@ -157,6 +157,7 @@
 
   @@index([countryId, code])
   @@index([cityId])
+  @@unique([countryId, code, placeName])
 }
 
 model Category {
diff --git a/db/scripts/seedGeography.ts b/db/scripts/seedGeography.ts
index 41088ca44820510f7bd9f7649a35125f411a4e8a..e4910149b9fac4616623d0fc92943cb9221c2c37
--- a/db/scripts/seedGeography.ts
+++ b/db/scripts/seedGeography.ts
@@ -53,7 +53,7 @@
   latitude?: string | number | null;
   longitude?: string | number | null;
   wikiDataId?: string | null;
-  population?: number | null;
+  population?: number | string | null;
   timezone?: string | null;
 };
 
@@ -274,7 +274,7 @@
       asciiName: sanitizeString(city.ascii_name),
       latitude: toFloat(city.latitude),
       longitude: toFloat(city.longitude),
-      population: city.population ?? null,
+      population: toInteger(city.population),
       timezone: sanitizeString(city.timezone),
       wikiDataId: sanitizeString(city.wikiDataId),
       stateId: city.state_id ?? null,
@@ -413,19 +413,15 @@
 }
 
 function resolveCityId(row: PostalRow, lookup: CityLookup): number | null {
-  const normalizedName = normalizeName(row.cityName ?? row.placeName);
-  if (!normalizedName) {
-    return null;
-  }
   const stateCode = sanitizeString(row.stateCode);
-  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, normalizedName);
+  const key = buildCityKey(row.countryCode.toUpperCase(), stateCode, row.cityName ?? row.placeName);
   if (key) {
     const exact = lookup.byCountryStateAndName.get(key);
     if (exact) {
       return exact;
     }
   }
-  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, normalizedName);
+  const fallbackKey = buildCityKey(row.countryCode.toUpperCase(), null, row.cityName ?? row.placeName);
   if (fallbackKey) {
     const fallback = lookup.byCountryAndName.get(fallbackKey);
     if (fallback) {
@@ -471,11 +467,11 @@
   return Number.isFinite(numeric) ? numeric : null;
 }
 
-function toInteger(value?: string | null): number | null {
-  if (!value) {
+function toInteger(value?: string | number | null): number | null {
+  if (value === null || value === undefined) {
     return null;
   }
-  const parsed = Number.parseInt(value, 10);
+  const parsed = typeof value === 'number' ? value : Number.parseInt(value, 10);
   return Number.isNaN(parsed) ? null : parsed;
 }
 
diff --git a/db/seed.ts b/db/seed.ts
index c8bae5fcdc721e6801912ea296154c55496f632d..8fe31a4cae48bb48bacf4d69390aaba7449f6584
--- a/db/seed.ts
+++ b/db/seed.ts
@@ -2,7 +2,233 @@
 
 const prisma = new PrismaClient();
 
+async function ensureDemoGeography() {
+  const unitedStates = await prisma.country.upsert({
+    where: { id: 233 },
+    update: {
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {}
+    },
+    create: {
+      id: 233,
+      name: 'United States',
+      iso2: 'US',
+      iso3: 'USA',
+      numericCode: '840',
+      phoneCode: '+1',
+      capital: 'Washington D.C.',
+      currency: 'USD',
+      currencyName: 'United States dollar',
+      currencySymbol: '$',
+      tld: '.us',
+      nativeName: 'United States',
+      region: 'Americas',
+      subregion: 'Northern America',
+      timezones: [
+        {
+          zoneName: 'America/New_York',
+          gmtOffset: -18000,
+          gmtOffsetName: 'UTC-05:00',
+          abbreviation: 'EST',
+          tzName: 'Eastern Standard Time'
+        }
+      ],
+      translations: {},
+      latitude: 38.893838,
+      longitude: -77.15466,
+      emoji: 'ðŸ‡ºðŸ‡¸',
+      emojiU: 'U+1F1FA U+1F1F8',
+      hasStates: true,
+      hasPostalCodes: true
+    }
+  });
+
+  const newYorkState = await prisma.stateProvince.upsert({
+    where: { id: 3930 },
+    update: {
+      name: 'New York',
+      stateCode: 'NY',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3930,
+      name: 'New York',
+      stateCode: 'NY',
+      type: 'state',
+      latitude: 43.2994285,
+      longitude: -74.2179326,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const californiaState = await prisma.stateProvince.upsert({
+    where: { id: 3876 },
+    update: {
+      name: 'California',
+      stateCode: 'CA',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    },
+    create: {
+      id: 3876,
+      name: 'California',
+      stateCode: 'CA',
+      type: 'state',
+      latitude: 36.778261,
+      longitude: -119.4179324,
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycCity = await prisma.city.upsert({
+    where: { id: 5128581 },
+    update: {
+      name: 'New York City',
+      asciiName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York'
+    },
+    create: {
+      id: 5128581,
+      name: 'New York City',
+      asciiName: 'New York',
+      latitude: 40.7127753,
+      longitude: -74.0059728,
+      timezone: 'America/New_York',
+      wikiDataId: 'Q60',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const sfCity = await prisma.city.upsert({
+    where: { id: 5391959 },
+    update: {
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California'
+    },
+    create: {
+      id: 5391959,
+      name: 'San Francisco',
+      asciiName: 'San Francisco',
+      latitude: 37.7749295,
+      longitude: -122.4194155,
+      timezone: 'America/Los_Angeles',
+      wikiDataId: 'Q62',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      countryId: unitedStates.id,
+      countryCode: 'US'
+    }
+  });
+
+  const nycPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '10004',
+        placeName: 'New York City'
+      }
+    },
+    update: {
+      stateId: newYorkState.id,
+      cityId: nycCity.id
+    },
+    create: {
+      code: '10004',
+      placeName: 'New York City',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: newYorkState.id,
+      stateCode: 'NY',
+      stateName: 'New York',
+      cityId: nycCity.id,
+      latitude: 40.6884,
+      longitude: -74.017,
+      accuracy: 1
+    }
+  });
+
+  const sfPostal = await prisma.postalCode.upsert({
+    where: {
+      countryId_code_placeName: {
+        countryId: unitedStates.id,
+        code: '94105',
+        placeName: 'San Francisco'
+      }
+    },
+    update: {
+      stateId: californiaState.id,
+      cityId: sfCity.id
+    },
+    create: {
+      code: '94105',
+      placeName: 'San Francisco',
+      countryId: unitedStates.id,
+      countryCode: 'US',
+      stateId: californiaState.id,
+      stateCode: 'CA',
+      stateName: 'California',
+      cityId: sfCity.id,
+      latitude: 37.7898,
+      longitude: -122.3942,
+      accuracy: 1
+    }
+  });
+
+  return {
+    country: unitedStates,
+    states: {
+      ny: newYorkState,
+      ca: californiaState
+    },
+    cities: {
+      nyc: nycCity,
+      sf: sfCity
+    },
+    postalCodes: {
+      nyc: nycPostal,
+      sf: sfPostal
+    }
+  };
+}
+
 async function main() {
+  const geography = await ensureDemoGeography();
   const adminUser = await prisma.user.upsert({
     where: { email: 'admin@example.com' },
     update: {},
@@ -41,25 +267,57 @@
 
   const nyc = await prisma.location.upsert({
     where: { slug: 'new-york-city' },
-    update: {},
+    update: {
+      state: 'NY',
+      country: 'US',
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
+    },
     create: {
       name: 'New York City',
       slug: 'new-york-city',
       state: 'NY',
       country: 'US',
-      timezone: 'America/New_York'
+      timezone: 'America/New_York',
+      latitude: 40.7128,
+      longitude: -74.006,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
   const sf = await prisma.location.upsert({
     where: { slug: 'san-francisco' },
-    update: {},
+    update: {
+      state: 'CA',
+      country: 'US',
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
+    },
     create: {
       name: 'San Francisco',
       slug: 'san-francisco',
       state: 'CA',
       country: 'US',
-      timezone: 'America/Los_Angeles'
+      timezone: 'America/Los_Angeles',
+      latitude: 37.7749,
+      longitude: -122.4194,
+      countryId: geography.country.id,
+      stateId: geography.states.ca.id,
+      cityId: geography.cities.sf.id,
+      postalCodeId: geography.postalCodes.sf.id
     }
   });
 
@@ -209,7 +467,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -253,6 +515,10 @@
       websiteUrl: 'https://harborhvac.example.com',
       contactEmail: 'contact@harborhvac.example.com',
       contactPhone: '+1-929-555-0100',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 90.1,
       rating: 4.7,
@@ -265,7 +531,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 
@@ -295,6 +565,10 @@
       websiteUrl: 'https://steadfast.example.com',
       contactEmail: 'hello@steadfast.example.com',
       contactPhone: '+1-917-555-0105',
+      city: 'New York',
+      region: 'NY',
+      postalCode: '10004',
+      country: 'US',
       status: 'APPROVED',
       score: 82.4,
       rating: 4.5,
@@ -307,7 +581,11 @@
       approvedById: adminUser.id,
       categoryId: servicesCategory.id,
       locationId: nyc.id,
-      directoryId: nycDirectory.id
+      directoryId: nycDirectory.id,
+      countryId: geography.country.id,
+      stateId: geography.states.ny.id,
+      cityId: geography.cities.nyc.id,
+      postalCodeId: geography.postalCodes.nyc.id
     }
   });
 

tokens used
156,105
**Database & Models**
- Added normalized geographic hierarchy models plus foreign-key back-references so listings/locations can bind directly to countries, states, cities, and postal codes (`db/schema.prisma:51`, `db/schema.prisma:85`, `db/schema.prisma:107`, `db/schema.prisma:134`, `db/schema.prisma:180`, `db/schema.prisma:265`).
- Introduced migration `002_location_hierarchy.sql` to create the new tables, compound indexes, and FK columns on `Location`/`Listing`, ensuring those relationships exist at the SQL layer as well (`db/migrations/002_location_hierarchy.sql:1`).
- Seed script now bootstraps canonical U.S. geography so the demo data has consistent foreign-key coverage; locations and listings link to the new entities and carry accurate lat/long/ZIP metadata (`db/seed.ts:5`, `db/seed.ts:268`, `db/seed.ts:442`).

**Geography Seeder & Docs**
- Implemented `db/scripts/seedGeography.ts` to load the dr5hn + GeoNames datasets with chunked `createMany` calls, stream postal data, and automatically flip `hasStates`/`hasPostalCodes` flags for countries lacking coverage (`db/scripts/seedGeography.ts:1`, `db/scripts/seedGeography.ts:360`).
- Documented how to obtain/place the upstream datasets and wired lightweight fixtures under `db/geography/sample/` so tests can run without the multi-GB exports (`db/geography/README.md:1`, `db/geography/sample/countries.json:1`).
- README now describes how to execute the new geography seed with either the bundled sample or full datasets, including the relevant environment variables (`README.md:37`).

**Tests**
- `npm test` (root)
