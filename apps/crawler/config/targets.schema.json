{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://mega-directory.dev/schemas/crawler-targets.json",
  "title": "Mega Directory Crawler Configuration",
  "type": "object",
  "description": "Schema describing crawler API targets, scraping targets, and optional LLM field generation rules.",
  "additionalProperties": true,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Optional pointer for tooling to locate this schema definition."
    },
    "api_endpoint": {
      "type": "string",
      "format": "uri",
      "description": "Single API endpoint to POST crawler batches to when api_targets is omitted."
    },
    "api_token": {
      "$ref": "#/$defs/nonEmptyString",
      "description": "Bearer token paired with api_endpoint."
    },
    "api_request_timeout": {
      "$ref": "#/$defs/positiveNumber",
      "description": "Override timeout (seconds) when posting batches to the API."
    },
    "request_timeout": {
      "$ref": "#/$defs/positiveNumber",
      "description": "Override timeout (seconds) for crawling requests."
    },
    "post_processing": {
      "$ref": "#/$defs/postProcessingConfig",
      "description": "Optional shared normalization + LLM enrichment settings applied to every target."
    },
    "api_targets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/apiTarget"
      },
      "description": "Optional list of named API targets (e.g., dev and prod)."
    },
    "targets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/target"
      },
      "description": "Collection of category/location scraping targets."
    }
  },
  "required": ["targets"],
  "allOf": [
    {
      "anyOf": [
        { "required": ["api_targets"] },
        { "required": ["api_endpoint", "api_token"] }
      ]
    }
  ],
  "$defs": {
    "nonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "positiveInteger": {
      "type": "integer",
      "minimum": 1
    },
    "positiveNumber": {
      "type": "number",
      "exclusiveMinimum": 0
    },
    "stringList": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/nonEmptyString"
      },
      "minItems": 1
    },
    "apiTarget": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "endpoint": {
          "type": "string",
          "format": "uri"
        },
        "token": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "api_token": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "bearer_token": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "timeout": {
          "$ref": "#/$defs/positiveNumber"
        }
      },
      "required": ["endpoint"],
      "allOf": [
        {
          "anyOf": [
            { "required": ["token"] },
            { "required": ["api_token"] },
            { "required": ["bearer_token"] }
          ]
        }
      ]
    },
    "target": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "category": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "category_slug": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "categorySlug": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "locations": {
          "$ref": "#/$defs/stringList"
        },
        "keywords": {
          "$ref": "#/$defs/stringList"
        },
        "subdomain": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "search_url_template": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "selectors": {
          "$ref": "#/$defs/selectors"
        },
        "address_selectors": {
          "$ref": "#/$defs/addressSelectors"
        },
        "address_patterns": {
          "$ref": "#/$defs/addressPatternList"
        },
        "fields": {
          "$ref": "#/$defs/fieldMap"
        },
        "category_rules": {
          "$ref": "#/$defs/categoryRuleList"
        },
        "category_classifier": {
          "$ref": "#/$defs/categoryClassifier"
        },
        "listings_per_location": {
          "$ref": "#/$defs/positiveInteger"
        },
        "request_timeout": {
          "$ref": "#/$defs/positiveNumber"
        },
        "api_request_timeout": {
          "$ref": "#/$defs/positiveNumber"
        },
        "source_name": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "sourceName": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "post_processing": {
          "$ref": "#/$defs/postProcessingConfig"
        }
      },
      "required": ["category", "locations"]
    },
    "addressSelectors": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "addressLine1": { "$ref": "#/$defs/nonEmptyString" },
        "addressLine2": { "$ref": "#/$defs/nonEmptyString" },
        "city": { "$ref": "#/$defs/nonEmptyString" },
        "region": { "$ref": "#/$defs/nonEmptyString" },
        "postalCode": { "$ref": "#/$defs/nonEmptyString" },
        "country": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "addressPatternList": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/addressPattern"
      }
    },
    "addressPattern": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pattern": { "$ref": "#/$defs/nonEmptyString" },
        "flags": {
          "type": "string",
          "pattern": "^[imsIMS]*$"
        }
      },
      "required": ["pattern"]
    },
    "categoryRuleList": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/categoryRule"
      }
    },
    "categoryRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "slug": { "$ref": "#/$defs/nonEmptyString" },
        "selector": { "$ref": "#/$defs/nonEmptyString" },
        "text": { "$ref": "#/$defs/nonEmptyString" },
        "pattern": { "$ref": "#/$defs/nonEmptyString" },
        "flags": {
          "type": "string",
          "pattern": "^[imsIMS]*$"
        }
      },
      "required": ["slug"],
      "allOf": [
        {
          "anyOf": [
            { "required": ["selector"] },
            { "required": ["text"] },
            { "required": ["pattern"] }
          ]
        }
      ]
    },
    "categoryClassifier": {
      "type": "object",
      "properties": {
        "provider": { "$ref": "#/$defs/nonEmptyString" },
        "model": { "$ref": "#/$defs/nonEmptyString" },
        "prompt_template": { "$ref": "#/$defs/nonEmptyString" },
        "choices": { "$ref": "#/$defs/stringList" },
        "tokens": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "options": {
          "type": "object"
        }
      },
      "required": ["provider", "model", "prompt_template"]
    },
    "llmGenerationConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "provider": { "$ref": "#/$defs/nonEmptyString" },
        "model": { "$ref": "#/$defs/nonEmptyString" },
        "prompt_template": { "$ref": "#/$defs/nonEmptyString" },
        "tokens": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "options": {
          "type": "object"
        },
        "always": {
          "type": "boolean"
        }
      },
      "required": ["provider", "model", "prompt_template"]
    },
    "postProcessingConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "normalize_titles": {
          "type": "boolean",
          "default": true
        },
        "summary_max_chars": {
          "$ref": "#/$defs/positiveInteger"
        },
        "description_max_chars": {
          "$ref": "#/$defs/positiveInteger"
        },
        "summary": {
          "$ref": "#/$defs/llmGenerationConfig"
        },
        "description": {
          "$ref": "#/$defs/llmGenerationConfig"
        }
      }
    },
    "selectors": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "listing": { "$ref": "#/$defs/nonEmptyString" },
        "title": { "$ref": "#/$defs/nonEmptyString" },
        "link": { "$ref": "#/$defs/nonEmptyString" },
        "description": { "$ref": "#/$defs/nonEmptyString" }
      }
    },
    "fieldMap": {
      "type": "object",
      "minProperties": 1,
      "patternProperties": {
        ".+": {
          "$ref": "#/$defs/fieldConfig"
        }
      }
    },
    "fieldConfig": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "source": {
          "type": "string",
          "enum": ["scrape", "ai"],
          "default": "scrape"
        },
        "attribute": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "provider": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "model": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "prompt_template": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "options": {
          "type": "object"
        },
        "tokens": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "source": { "const": "ai" }
            }
          },
          "then": {
            "required": ["provider", "model", "prompt_template"]
          }
        }
      ]
    }
  }
}
