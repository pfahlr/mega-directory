<%
  const creationValues = creationDraft || {};
  const creationErr = creationErrors || {};
  const existingErrors = updateErrors || {};

  function fieldHasError(errors, key) {
    if (!errors) return false;
    return Boolean(errors[key]);
  }

  function fieldMessage(errors, key) {
    if (!errors) return null;
    return errors[key] || null;
  }

  function formatTimestamp(value) {
    if (!value) return 'Unknown';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return 'Unknown';
    }
    return date.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
  }
%>
<%- include('../partials/page-start', { title: title || 'Directory Page Builder', active }) %>
<section class="panel stack gap-lg directory-admin">
  <header class="panel-header">
    <div>
      <p class="eyebrow">Directories</p>
      <h2>Craft category + location pages</h2>
      <p class="muted">Set routing, hero copy, and SEO metadata for each directory page before publishing.</p>
    </div>
    <div class="badge">Total pages <strong><%= pages.length %></strong></div>
  </header>

  <% if (typeof createdCount === 'number' && createdCount > 0) { %>
    <div class="alert success">Created <strong><%= createdCount %></strong> new directory page.</div>
  <% } %>
  <% if (typeof savedCount === 'number' && savedCount > 0) { %>
    <div class="alert success">Saved <strong><%= savedCount %></strong> director<%= savedCount === 1 ? 'y' : 'ies' %>.</div>
  <% } %>

  <section class="stack gap-md directory-create">
    <div class="section-heading">
      <h3>Create a new directory page</h3>
      <p class="muted">Link a category and location, then provide metadata overrides.</p>
    </div>
    <form method="POST" action="/directory-pages" class="stack gap-md">
      <input type="hidden" name="intent" value="create" />
      <input type="hidden" name="newPage[locationAgnostic]" value="0" />

      <div class="field-grid">
        <label class="field-label">Page title
          <input
            class="field-control <%= fieldHasError(creationErr, 'title') ? 'is-invalid' : '' %>"
            type="text"
            name="newPage[title]"
            value="<%= creationValues.title || '' %>"
            placeholder="Best Electricians in Austin" />
          <% if (fieldHasError(creationErr, 'title')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'title') %></p>
          <% } %>
        </label>

        <label class="field-label">Category
          <select
            class="field-control <%= fieldHasError(creationErr, 'categoryId') ? 'is-invalid' : '' %>"
            name="newPage[categoryId]">
            <option value="">Select category</option>
            <% categories.forEach((category) => { %>
              <option value="<%= category.id %>" <%= creationValues.categoryId === category.id ? 'selected' : '' %>><%= category.label %></option>
            <% }) %>
          </select>
          <% if (fieldHasError(creationErr, 'categoryId')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'categoryId') %></p>
          <% } %>
        </label>

        <label class="field-label">Location (optional when agnostic)
          <select
            class="field-control <%= fieldHasError(creationErr, 'locationId') ? 'is-invalid' : '' %>"
            name="newPage[locationId]">
            <option value="">Select location</option>
            <% locations.forEach((location) => { %>
              <option value="<%= location.id %>" <%= creationValues.locationId === location.id ? 'selected' : '' %>><%= location.label %></option>
            <% }) %>
          </select>
          <% if (fieldHasError(creationErr, 'locationId')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'locationId') %></p>
          <% } %>
        </label>

        <label class="toggle-label">
          <input type="checkbox" name="newPage[locationAgnostic]" value="1" <%= creationValues.locationAgnostic ? 'checked' : '' %> />
          Location agnostic page
        </label>
      </div>

      <div class="field-grid">
        <label class="field-label">Subdomain
          <input
            class="field-control <%= fieldHasError(creationErr, 'subdomain') ? 'is-invalid' : '' %>"
            type="text"
            name="newPage[subdomain]"
            placeholder="austin-plumbers"
            value="<%= creationValues.subdomain || '' %>" />
          <% if (fieldHasError(creationErr, 'subdomain')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'subdomain') %></p>
          <% } %>
        </label>

        <label class="field-label">Subdirectory
          <input
            class="field-control <%= fieldHasError(creationErr, 'subdirectory') ? 'is-invalid' : '' %>"
            type="text"
            name="newPage[subdirectory]"
            placeholder="austin-tx/plumbers"
            value="<%= creationValues.subdirectory || '' %>" />
          <% if (fieldHasError(creationErr, 'subdirectory')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'subdirectory') %></p>
          <% } %>
        </label>
      </div>

      <div class="field-grid">
        <label class="field-label">Hero title
          <input class="field-control" type="text" name="newPage[heroTitle]" value="<%= creationValues.heroTitle || '' %>" />
        </label>
        <label class="field-label">Hero subtitle
          <input class="field-control" type="text" name="newPage[heroSubtitle]" value="<%= creationValues.heroSubtitle || '' %>" />
        </label>
      </div>

      <label class="field-label">Intro markdown
        <textarea class="field-control" name="newPage[introMarkdown]" rows="3" placeholder="Short intro copy."><%= creationValues.introMarkdown || '' %></textarea>
      </label>

      <div class="field-grid">
        <label class="field-label">Meta title
          <input
            class="field-control <%= fieldHasError(creationErr, 'metaTitle') ? 'is-invalid' : '' %>"
            type="text"
            name="newPage[metaTitle]"
            value="<%= creationValues.metaTitle || '' %>" />
          <% if (fieldHasError(creationErr, 'metaTitle')) { %>
            <p class="field-error"><%= fieldMessage(creationErr, 'metaTitle') %></p>
          <% } %>
        </label>
        <label class="field-label">Meta keywords
          <input class="field-control" type="text" name="newPage[metaKeywords]" value="<%= creationValues.metaKeywords || '' %>" />
        </label>
      </div>

      <label class="field-label">Meta description
        <textarea
          class="field-control <%= fieldHasError(creationErr, 'metaDescription') ? 'is-invalid' : '' %>"
          name="newPage[metaDescription]"
          rows="3"
          placeholder="150-160 characters ideal."><%= creationValues.metaDescription || '' %></textarea>
        <% if (fieldHasError(creationErr, 'metaDescription')) { %>
          <p class="field-error"><%= fieldMessage(creationErr, 'metaDescription') %></p>
        <% } %>
      </label>

      <label class="field-label">OG image URL
        <input class="field-control" type="url" name="newPage[ogImageUrl]" placeholder="https://cdn.example.com/og.png" value="<%= creationValues.ogImageUrl || '' %>" />
      </label>

      <div class="form-actions">
        <button type="submit" class="btn primary">Create directory page</button>
        <p class="muted">Entries are stored in-memory until API wiring is completed.</p>
      </div>
    </form>
  </section>

  <section class="stack gap-md">
    <div class="section-heading">
      <h3>Edit existing pages</h3>
      <p class="muted">Toggle save/deactivate to control publish state.</p>
    </div>

    <% if (!pages.length) { %>
      <p class="empty-state">No directory pages yet. Create one above.</p>
    <% } else { %>
      <form method="POST" action="/directory-pages" class="stack gap-md">
        <input type="hidden" name="intent" value="bulk-update" />
        <div class="stack gap-md">
          <% pages.forEach((page, index) => { %>
            <% const errors = existingErrors[page.id]; %>
            <article class="directory-card stack gap-md">
              <header class="directory-card__header">
                <div>
                  <p class="eyebrow"><%= page.categoryLabel %></p>
                  <h4><%= page.title %></h4>
                  <p class="muted">Location: <strong><%= page.locationLabel %></strong></p>
                  <p class="muted">Status <strong class="status-label"><%= (page.status || 'draft').toLowerCase() %></strong> â€¢ Updated <strong><%= formatTimestamp(page.updatedAt) %></strong></p>
                </div>
                <div class="directory-card__toggles">
                  <label class="toggle-label">
                    <input type="checkbox" name="pages[<%= index %>][save]" value="1" <%= page.isActive ? 'checked' : '' %> />
                    Save / Publish
                  </label>
                  <label class="toggle-label">
                    <input type="checkbox" name="pages[<%= index %>][deactivate]" value="1" <%= !page.isActive && page.status === 'ARCHIVED' ? 'checked' : '' %> />
                    Deactivate
                  </label>
                </div>
              </header>

              <% if (errors) { %>
                <div class="alert" style="background:#fef2f2;color:#b91c1c;">
                  <strong>Fix required:</strong> <%= Object.values(errors).join(', ') %>
                </div>
              <% } %>

              <input type="hidden" name="pages[<%= index %>][id]" value="<%= page.id %>" />
              <input type="hidden" name="pages[<%= index %>][locationAgnostic]" value="0" />

              <div class="field-grid">
                <label class="field-label">Page title
                  <input class="field-control <%= fieldHasError(errors, 'title') ? 'is-invalid' : '' %>" type="text" name="pages[<%= index %>][title]" value="<%= page.title %>" />
                  <% if (fieldHasError(errors, 'title')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'title') %></p>
                  <% } %>
                </label>

                <label class="field-label">Category
                  <select class="field-control <%= fieldHasError(errors, 'categoryId') ? 'is-invalid' : '' %>" name="pages[<%= index %>][categoryId]">
                    <option value="">Select category</option>
                    <% categories.forEach((category) => { %>
                      <option value="<%= category.id %>" <%= page.categoryId === category.id ? 'selected' : '' %>><%= category.label %></option>
                    <% }) %>
                  </select>
                  <% if (fieldHasError(errors, 'categoryId')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'categoryId') %></p>
                  <% } %>
                </label>

                <label class="field-label">Location
                  <select class="field-control <%= fieldHasError(errors, 'locationId') ? 'is-invalid' : '' %>" name="pages[<%= index %>][locationId]">
                    <option value="">Select location</option>
                    <% locations.forEach((location) => { %>
                      <option value="<%= location.id %>" <%= page.locationId === location.id ? 'selected' : '' %>><%= location.label %></option>
                    <% }) %>
                  </select>
                  <p class="location-note">Leave blank if location agnostic.</p>
                  <% if (fieldHasError(errors, 'locationId')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'locationId') %></p>
                  <% } %>
                </label>

                <label class="toggle-label">
                  <input type="checkbox" name="pages[<%= index %>][locationAgnostic]" value="1" <%= page.locationAgnostic ? 'checked' : '' %> />
                  Location agnostic directory
                </label>
              </div>

              <div class="field-grid">
                <label class="field-label">Subdomain
                  <input class="field-control <%= fieldHasError(errors, 'subdomain') ? 'is-invalid' : '' %>" type="text" name="pages[<%= index %>][subdomain]" value="<%= page.subdomain %>" />
                  <% if (fieldHasError(errors, 'subdomain')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'subdomain') %></p>
                  <% } %>
                </label>
                <label class="field-label">Subdirectory
                  <input class="field-control <%= fieldHasError(errors, 'subdirectory') ? 'is-invalid' : '' %>" type="text" name="pages[<%= index %>][subdirectory]" value="<%= page.subdirectory %>" />
                  <% if (fieldHasError(errors, 'subdirectory')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'subdirectory') %></p>
                  <% } %>
                </label>
              </div>

              <div class="field-grid">
                <label class="field-label">Hero title
                  <input class="field-control" type="text" name="pages[<%= index %>][heroTitle]" value="<%= page.heroTitle %>" />
                </label>
                <label class="field-label">Hero subtitle
                  <input class="field-control" type="text" name="pages[<%= index %>][heroSubtitle]" value="<%= page.heroSubtitle %>" />
                </label>
              </div>

              <label class="field-label">Intro markdown
                <textarea class="field-control" name="pages[<%= index %>][introMarkdown]" rows="3"><%= page.introMarkdown %></textarea>
              </label>

              <div class="field-grid">
                <label class="field-label">Meta title
                  <input class="field-control <%= fieldHasError(errors, 'metaTitle') ? 'is-invalid' : '' %>" type="text" name="pages[<%= index %>][metaTitle]" value="<%= page.metaTitle %>" />
                  <% if (fieldHasError(errors, 'metaTitle')) { %>
                    <p class="field-error"><%= fieldMessage(errors, 'metaTitle') %></p>
                  <% } %>
                </label>
                <label class="field-label">Meta keywords
                  <input class="field-control" type="text" name="pages[<%= index %>][metaKeywords]" value="<%= page.metaKeywords %>" />
                </label>
              </div>

              <label class="field-label">Meta description
                <textarea class="field-control <%= fieldHasError(errors, 'metaDescription') ? 'is-invalid' : '' %>" name="pages[<%= index %>][metaDescription]" rows="3"><%= page.metaDescription %></textarea>
                <% if (fieldHasError(errors, 'metaDescription')) { %>
                  <p class="field-error"><%= fieldMessage(errors, 'metaDescription') %></p>
                <% } %>
              </label>

              <label class="field-label">OG image URL
                <input class="field-control" type="url" name="pages[<%= index %>][ogImageUrl]" value="<%= page.ogImageUrl %>" />
              </label>
            </article>
          <% }) %>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary">Save directory edits</button>
          <p class="muted">Updates apply immediately in this demo.</p>
        </div>
      </form>
    <% } %>
  </section>
</section>
<%- include('../partials/page-end') %>
